<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - St. Lawrence Junior School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066cc;
            --dark-blue: #0052a3;
            --accent-red: #dc3545;
            --dark-bg: #1a1d2e;
            --darker-bg: #151824;
            --card-bg: #22283a;
            --text-light: #e4e6eb;
            --text-gray: #9ca3af;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            overflow-x: hidden;
        }

        /* Main content background that changes */
        .main-content {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            transition: background 2s ease;
        }

        .main-content.bg-1 {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .main-content.bg-2 {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .main-content.bg-3 {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .main-content.bg-4 {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .main-content.bg-5 {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .main-content.bg-6 {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 15px;
            top: 15px;
            width: 260px;
            height: calc(100vh - 30px);
            min-height: 600px;
            background: var(--darker-bg);
            border-radius: 20px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            border-radius: 20px 20px 0 0;
            flex-shrink: 0;
        }

        .sidebar-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-title {
            flex: 1;
        }

        .sidebar-title h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .sidebar-title p {
            font-size: 11px;
            color: var(--text-gray);
        }

        .sidebar-menu {
            padding: 20px 0 30px 0;
            flex-shrink: 0;
            flex: 1;
        }

        .menu-item {
            padding: 18px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-gray);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 14px;
            position: relative;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-light);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
            border-radius: 10px;
            margin: 0 10px;
            padding-left: 10px;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .menu-item .menu-text {
            flex: 1;
        }

        .menu-item .dropdown-icon {
            font-size: 12px;
            transition: transform 0.3s;
        }

        .menu-item.expanded .dropdown-icon {
            transform: rotate(180deg);
        }

        /* Submenu */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.2);
            margin: 0 10px 15px 10px;
            border-radius: 10px;
            position: relative;
        }

        .submenu.open {
            max-height: 500px;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .submenu-item {
            padding: 15px 20px 15px 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-gray);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 13px;
            position: relative;
            margin-bottom: 6px;
        }

        /* Vertical line */
        .submenu-item::before {
            content: '';
            position: absolute;
            left: 25px;
            top: 0;
            bottom: 50%;
            width: 2px;
            background: rgba(255,255,255,0.2);
        }

        /* Horizontal line */
        .submenu-item::after {
            content: '';
            position: absolute;
            left: 25px;
            top: 50%;
            width: 15px;
            height: 2px;
            background: rgba(255,255,255,0.2);
        }

        /* Remove bottom part of vertical line for last item */
        .submenu-item:last-child::before {
            bottom: 50%;
        }

        .submenu-item:hover {
            color: var(--text-light);
            background: rgba(255,255,255,0.05);
        }

        .submenu-item.active {
            color: var(--primary-blue);
            background: rgba(0, 102, 204, 0.1);
        }

        .submenu-item i {
            width: 18px;
            text-align: center;
            font-size: 14px;
        }
        
        /* Notification Badge */
        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--darker-bg);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            min-height: 70px;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            cursor: pointer;
            display: none;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title h1 i {
            font-size: 18px;
            color: var(--primary-blue);
        }

        .top-bar-center {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex: 1;
            padding: 0 20px;
            max-width: 800px;
        }

        /* Date Time Card - Compact */
        .datetime-card {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1) 0%, rgba(0, 82, 163, 0.15) 100%);
            padding: 12px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(0, 102, 204, 0.2);
            transition: all 0.3s;
            flex: 1;
            max-width: 280px;
        }

        .datetime-card:hover {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.15) 0%, rgba(0, 82, 163, 0.2) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.2);
        }

        .datetime-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .datetime-card .date-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .datetime-card .date {
            font-size: 11px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .datetime-card .time {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            letter-spacing: 1px;
            line-height: 1;
        }

        /* Greeting Card - Compact */
        .greeting-card {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            transition: all 0.3s;
            flex: 1;
            max-width: 280px;
        }

        .greeting-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .greeting-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .greeting-content {
            flex: 1;
            min-width: 0;
        }

        .greeting-card .greeting-text {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 3px;
            font-family: 'Poppins', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .greeting-card .greeting-name {
            font-size: 12px;
            opacity: 0.95;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .top-bar-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 18px;
            color: var(--text-gray);
        }

        .top-bar-icon:hover {
            background: rgba(0, 102, 204, 0.15);
            color: var(--primary-blue);
            transform: translateY(-2px);
        }

        .top-bar-icon .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent-red);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--darker-bg);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--card-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 8px;
            position: relative;
        }

        .user-profile:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }
        
        /* User Dropdown Menu */
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 30px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            min-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 9999;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-dropdown-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        
        .user-dropdown-header .avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            margin: 0 auto 12px;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4);
        }
        
        .user-dropdown-header .name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        
        .user-dropdown-header .email {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .user-dropdown-menu {
            padding: 8px;
        }
        
        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
        }
        
        .user-dropdown-item:hover {
            background: rgba(0, 102, 204, 0.1);
            color: var(--primary-blue);
        }
        
        .user-dropdown-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        .user-dropdown-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.3);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-info .name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
        }

        .user-info .role {
            font-size: 11px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Logout Button - Redesigned */
        .btn-logout {
            background: linear-gradient(135deg, var(--accent-red) 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .btn-logout:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-logout i {
            font-size: 16px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            min-height: 160px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.blue { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
        .stat-card.red { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); }
        .stat-card.green { background: linear-gradient(135deg, #065f46 0%, #059669 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }

        .stat-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.8;
            font-weight: 600;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1;
        }

        .stat-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            opacity: 0.8;
            margin-top: 15px;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .quick-actions .section-header {
            margin-bottom: 20px;
        }

        .quick-actions .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .quick-actions .actions-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .quick-actions .actions-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .section-header h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .view-all {
            color: var(--primary-blue);
            font-size: 13px;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 8px;
            background: rgba(0, 102, 204, 0.1);
            transition: all 0.3s;
        }

        .view-all:hover {
            background: rgba(0, 102, 204, 0.2);
        }



        .action-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 30px 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #1e293b;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px solid #e9ecef;
            position: relative;
            overflow: hidden;
            min-height: 180px;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--dark-blue));
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .action-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary-blue);
            box-shadow: 0 12px 30px rgba(0, 102, 204, 0.15);
            background: white;
        }

        .action-icon {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .action-card:hover .action-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .action-icon.blue { 
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.2)); 
            color: var(--primary-blue); 
        }
        .action-icon.red { 
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.2)); 
            color: var(--accent-red); 
        }
        .action-icon.green { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)); 
            color: var(--success-green); 
        }
        .action-icon.purple { 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.2)); 
            color: #8b5cf6; 
        }
        .action-icon.orange { 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2)); 
            color: var(--warning-orange); 
        }

        .action-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .action-card h4 {
            font-size: 17px;
            margin-bottom: 10px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .action-card p {
            font-size: 13px;
            color: #64748b;
            line-height: 1.6;
            margin: 0 0 15px 0;
        }

        .action-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--primary-blue);
            font-size: 14px;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 8px;
            background: rgba(0, 102, 204, 0.05);
            transition: all 0.3s;
        }

        .action-card:hover .action-link {
            background: rgba(0, 102, 204, 0.1);
            transform: translateX(5px);
        }

        .action-link i {
            font-size: 12px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen i {
            font-size: 48px;
            color: var(--primary-blue);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Dashboard Content Area */
        .dashboard-content {
            padding: 30px;
        }

        /* Welcome Section - Enhanced Header */
        .welcome-section {
            margin-bottom: 35px;
            background: white;
            padding: 35px 40px;
            border-radius: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary-blue);
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.03) 0%, rgba(0, 82, 163, 0.05) 100%);
            border-radius: 0 20px 20px 0;
        }

        .welcome-section .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;
        }

        .welcome-section .header-left {
            flex: 1;
        }

        .welcome-section h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 28px;
            margin-bottom: 8px;
            color: #0f172a;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .welcome-section h2 i {
            font-size: 26px;
            color: var(--primary-blue);
        }

        .welcome-section p {
            color: #475569;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.6;
        }

        .welcome-section .header-right {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .header-action-btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
            white-space: nowrap;
        }

        .header-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .header-action-btn i {
            font-size: 14px;
        }

        .header-action-btn.secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            box-shadow: 0 2px 10px rgba(0, 102, 204, 0.1);
        }

        .header-action-btn.secondary:hover {
            background: rgba(0, 102, 204, 0.05);
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.2);
        }

        /* Responsive header */
        @media (max-width: 1024px) {
            .welcome-section .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .welcome-section .header-right {
                width: 100%;
                justify-content: flex-start;
            }
        }

        /* Adjust text colors for light background */
        .main-content .welcome-section h2 {
            color: #0f172a;
            font-family: 'Poppins', sans-serif;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .main-content .welcome-section p {
            color: #334155;
            font-size: 15px;
            font-weight: 500;
        }

        .main-content .section-header h3 {
            color: #1e293b;
            font-weight: 600;
        }

        .main-content .view-all {
            color: var(--primary-blue);
            background: rgba(0, 102, 204, 0.1);
            font-weight: 600;
        }

        .main-content .view-all:hover {
            background: rgba(0, 102, 204, 0.2);
        }

        /* Activity and event text colors */
        .activity-title,
        .event-title,
        .notification-title,
        .performance-label {
            color: #1e293b !important;
        }

        .activity-desc,
        .event-time,
        .notification-text {
            color: #475569 !important;
        }

        .activity-time,
        .notification-time {
            color: #64748b !important;
        }

        /* Right Icon Rail */
        .right-rail {
            position: fixed;
            right: 15px;
            top: 15px;
            width: 70px;
            height: calc(100vh - 30px);
            background: var(--darker-bg);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            gap: 25px;
            z-index: 999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .rail-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            color: var(--text-gray);
            font-size: 20px;
        }

        .rail-icon:hover {
            background: rgba(0, 102, 204, 0.15);
            color: var(--primary-blue);
            transform: translateX(-5px);
        }

        .rail-icon.active {
            background: rgba(0, 102, 204, 0.2);
            color: var(--primary-blue);
        }

        .rail-icon .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .rail-divider {
            width: 35px;
            height: 2px;
            background: rgba(255,255,255,0.1);
            margin: 15px 0;
        }

        /* Adjust main content for right rail */
        .main-content {
            margin-left: 290px;
            margin-right: 100px;
            min-height: 100vh;
        }

        /* Two Column Layout */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        @media (max-width: 1200px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Section */
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 100%;
            min-height: 350px;
        }

        .chart-section .section-header {
            margin-bottom: 15px;
        }

        .chart-section canvas {
            width: 100% !important;
            height: 280px !important;
        }

        .chart-filter {
            background: #f1f5f9;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .chart-filter:hover {
            background: #e2e8f0;
            border-color: var(--primary-blue);
        }

        /* Activity Section */
        .activity-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 100%;
            max-height: 450px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .activity-section .section-header {
            flex-shrink: 0;
        }

        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .activity-timeline::-webkit-scrollbar {
            width: 6px;
        }

        .activity-timeline::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .activity-timeline::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .activity-timeline::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .activity-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .activity-icon.blue { background: rgba(0, 102, 204, 0.15); color: var(--primary-blue); }
        .activity-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success-green); }
        .activity-icon.red { background: rgba(220, 53, 69, 0.15); color: var(--accent-red); }
        .activity-icon.purple { background: rgba(123, 97, 255, 0.15); color: #7b61ff; }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            font-size: 13px;
            color: #1e293b;
            margin-bottom: 3px;
        }

        .activity-desc {
            font-size: 12px;
            color: #475569;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 11px;
            color: #64748b;
        }

        /* Calendar Widget */
        .calendar-widget {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 100%;
            max-height: 450px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-widget .section-header {
            flex-shrink: 0;
        }

        .calendar-mini {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .calendar-month {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 5px 10px;
            font-size: 14px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .calendar-day-name {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            padding: 6px 0;
        }

        .calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            flex: 1;
            align-content: start;
            overflow-y: auto;
        }

        .calendar-dates::-webkit-scrollbar {
            width: 4px;
        }

        .calendar-dates::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .calendar-dates::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .calendar-dates::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .calendar-date {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 32px;
        }

        .calendar-date:hover {
            background: #e9ecef;
        }

        .calendar-date.today {
            background: var(--primary-blue);
            color: white;
            font-weight: 600;
        }

        .calendar-date.event {
            background: rgba(0, 102, 204, 0.1);
            color: var(--primary-blue);
            font-weight: 600;
        }

        /* Upcoming Events */
        .upcoming-events {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 100%;
            max-height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .upcoming-events .section-header {
            flex-shrink: 0;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .events-list::-webkit-scrollbar {
            width: 6px;
        }

        .events-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .events-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .events-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .event-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .event-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .event-date {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .event-day {
            font-size: 22px;
            font-weight: 700;
            line-height: 1;
        }

        .event-month {
            font-size: 10px;
            font-weight: 600;
            margin-top: 3px;
        }

        .event-details {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            font-size: 13px;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .event-time {
            font-size: 11px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Notifications Widget */
        .notifications-widget {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .notification-item.unread {
            background: rgba(0, 102, 204, 0.05);
            border-left: 3px solid var(--primary-blue);
        }

        .notification-item:hover {
            background: #e9ecef;
        }

        .notification-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .notification-icon.blue { background: rgba(0, 102, 204, 0.15); color: var(--primary-blue); }
        .notification-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success-green); }
        .notification-icon.red { background: rgba(220, 53, 69, 0.15); color: var(--accent-red); }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: #1e293b;
            margin-bottom: 3px;
        }

        .notification-text {
            font-size: 12px;
            color: #475569;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 11px;
            color: #64748b;
        }

        /* Performance Widget */
        .performance-widget {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .performance-items {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .performance-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .performance-label {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .performance-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--dark-blue));
            border-radius: 10px;
            transition: width 1s ease;
        }

        .performance-fill.green {
            background: linear-gradient(90deg, var(--success-green), #059669);
        }

        .performance-fill.orange {
            background: linear-gradient(90deg, var(--warning-orange), #d97706);
        }

        .performance-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        @media (max-width: 1200px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                margin-right: 0;
            }

            .menu-toggle {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .right-rail {
                display: none;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--darker-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 20px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: rgba(255, 255, 255, 0.05);
        }

        textarea.form-control {
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.4);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Messages Section */
        .messages-container {
            max-width: 1200px;
        }

        .message-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .message-card.unread {
            border-left: 4px solid var(--primary-blue);
            background: #f0f7ff;
        }

        .message-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .message-sender {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message-sender i {
            font-size: 2.5rem;
            color: var(--primary-blue);
        }

        .message-sender h4 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
        }

        .message-sender p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        .message-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .message-date {
            font-size: 0.85rem;
            color: #999;
        }

        .message-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-status.new {
            background: #e3f2fd;
            color: #1976d2;
        }

        .message-status.read {
            background: #f5f5f5;
            color: #666;
        }

        .message-status.replied {
            background: #e8f5e9;
            color: #388e3c;
        }

        .message-subject {
            font-size: 1rem;
            margin-bottom: 12px;
            color: #555;
        }

        .message-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #666;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .message-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* Large Modal */
        .modal-large .modal-content {
            max-width: 1000px;
            max-height: 85vh;
        }

        .modal-content-large {
            display: flex;
            flex-direction: column;
        }

        .modal-content-large .modal-body {
            flex: 1;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        /* Advanced Loader */
        .advanced-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            min-height: 400px;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 102, 204, 0.1);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            margin-top: 20px;
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        /* Loader Variation 1: Dots Bounce (for Messages) */
        .loader-dots {
            display: flex;
            gap: 10px;
        }

        .loader-dots span {
            width: 15px;
            height: 15px;
            background: var(--primary-blue);
            border-radius: 50%;
            animation: dotBounce 1.4s infinite ease-in-out both;
        }

        .loader-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loader-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes dotBounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Loader Variation 2: Pulse Ring (for Gallery) */
        .loader-pulse {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loader-pulse::before,
        .loader-pulse::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }

        .loader-pulse::after {
            animation-delay: 1s;
        }

        @keyframes pulse {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Loader Variation 3: Dual Ring (for Teachers) */
        .loader-dual-ring {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loader-dual-ring::before {
            content: '';
            display: block;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--primary-blue);
            border-bottom-color: var(--accent-red);
            border-radius: 50%;
            animation: dualRing 1.2s linear infinite;
        }

        @keyframes dualRing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loader Variation 4: Bars Wave (for Events) */
        .loader-bars {
            display: flex;
            gap: 6px;
            align-items: center;
            height: 60px;
        }

        .loader-bars span {
            width: 8px;
            height: 40px;
            background: var(--primary-blue);
            border-radius: 4px;
            animation: barsWave 1.2s ease-in-out infinite;
        }

        .loader-bars span:nth-child(1) {
            animation-delay: 0s;
        }

        .loader-bars span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .loader-bars span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .loader-bars span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .loader-bars span:nth-child(5) {
            animation-delay: 0.4s;
        }

        @keyframes barsWave {
            0%, 100% {
                height: 20px;
                background: var(--primary-blue);
            }
            50% {
                height: 60px;
                background: var(--accent-red);
            }
        }

        /* Loader Variation 5: Orbit (for Testimonials) */
        .loader-orbit {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loader-orbit span {
            position: absolute;
            width: 15px;
            height: 15px;
            background: var(--primary-blue);
            border-radius: 50%;
            animation: orbit 1.5s linear infinite;
        }

        .loader-orbit span:nth-child(1) {
            animation-delay: 0s;
        }

        .loader-orbit span:nth-child(2) {
            animation-delay: 0.5s;
        }

        .loader-orbit span:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes orbit {
            0% {
                top: 0;
                left: 50%;
                transform: translateX(-50%);
            }
            25% {
                top: 50%;
                left: 100%;
                transform: translate(-100%, -50%);
            }
            50% {
                top: 100%;
                left: 50%;
                transform: translate(-50%, -100%);
            }
            75% {
                top: 50%;
                left: 0;
                transform: translateY(-50%);
            }
            100% {
                top: 0;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* Loader Variation 6: Flip Square (for Calendar) */
        .loader-flip {
            width: 50px;
            height: 50px;
            background: var(--primary-blue);
            animation: flip 1.5s ease-in-out infinite;
        }

        @keyframes flip {
            0%, 100% {
                transform: perspective(200px) rotateY(0deg);
                background: var(--primary-blue);
            }
            50% {
                transform: perspective(200px) rotateY(180deg);
                background: var(--accent-red);
            }
        }

        /* Modal Loading Overlay */
        .modal-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .modal-loading-overlay.active {
            display: flex;
        }

        .modal-loading-content {
            text-align: center;
            animation: fadeInScale 0.3s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-loading-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 20px;
            font-family: 'Poppins', sans-serif;
        }

        /* Messages in Modal */
        .messages-container {
            padding: 20px;
        }

        .messages-list {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <i class="fas fa-spinner"></i>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="../../img/5.jpg" alt="School Logo">
            </div>
            <div class="sidebar-title">
                <h3>ST. LAWRENCE</h3>
                <p>JUNIOR SCHOOL</p>
            </div>
        </div>

        <div class="sidebar-menu">
            <a href="dashboard.html" class="menu-item active">
                <i class="fas fa-chart-line"></i>
                <span class="menu-text">Dashboard</span>
            </a>

            <div class="menu-item" onclick="toggleSubmenu(this)">
                <i class="fas fa-users"></i>
                <span class="menu-text">Students</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="submenu">
                <a href="#" class="submenu-item">
                    <i class="fas fa-list"></i>
                    <span>All Students</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Student</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Details</span>
                </a>
            </div>

            <div class="menu-item" onclick="toggleSubmenu(this)">
                <i class="fas fa-user-tie"></i>
                <span class="menu-text">Staff Management</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="submenu">
                <a href="#" class="submenu-item">
                    <i class="fas fa-list"></i>
                    <span>All Staff</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Staff</span>
                </a>
            </div>

            <div class="menu-item" onclick="toggleSubmenu(this)">
                <i class="fas fa-graduation-cap"></i>
                <span class="menu-text">Academics</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="submenu">
                <a href="#" class="submenu-item">
                    <i class="fas fa-book"></i>
                    <span>Classes</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-chalkboard"></i>
                    <span>Subjects</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Timetable</span>
                </a>
                <a href="#" class="submenu-item" onclick="showAdmissionsSection(); return false;">
                    <i class="fas fa-user-graduate"></i>
                    <span>Admissions</span>
                    <span class="notification-badge" id="admissionsBadge" style="display: none;">0</span>
                </a>
            </div>

            <div class="menu-item" onclick="toggleSubmenu(this)">
                <i class="fas fa-folder"></i>
                <span class="menu-text">Content</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="submenu">
                <a href="#" class="submenu-item" onclick="showTeachersSection(); return false;">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Teachers</span>
                </a>
                <a href="#" class="submenu-item" onclick="showEventsModal(); return false;">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </a>
                <a href="#" class="submenu-item" onclick="showImportantDaysModal(); return false;">
                    <i class="fas fa-star"></i>
                    <span>Important Days</span>
                </a>
                <a href="#" class="submenu-item" onclick="showAcademicCalendarModal(); return false;">
                    <i class="fas fa-calendar-check"></i>
                    <span>Academic Calendar</span>
                </a>
                <a href="#" class="submenu-item" onclick="showLibrarySection(); return false;">
                    <i class="fas fa-book"></i>
                    <span>Library</span>
                </a>
                <a href="#" class="submenu-item" onclick="showGallerySection(); return false;">
                    <i class="fas fa-images"></i>
                    <span>Gallery</span>
                </a>
                <a href="#" class="submenu-item" onclick="openModal('testimonialModal'); return false;">
                    <i class="fas fa-quote-left"></i>
                    <span>Testimonials</span>
                </a>
                <a href="#" class="submenu-item" onclick="showMessagesSection(); return false;">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                    <span class="notification-badge" id="messagesBadge" style="display: none;">0</span>
                </a>
            </div>

            <div class="menu-item" onclick="toggleSubmenu(this)">
                <i class="fas fa-dollar-sign"></i>
                <span class="menu-text">Finance</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="submenu">
                <a href="#" class="submenu-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Fee Collection</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-receipt"></i>
                    <span>Expenses</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </div>

            <div class="menu-item" onclick="toggleSubmenu(this)">
                <i class="fas fa-comments"></i>
                <span class="menu-text">Communications</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>
            <div class="submenu">
                <a href="#" class="submenu-item">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-sms"></i>
                    <span>SMS</span>
                </a>
                <a href="#" class="submenu-item">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </a>
            </div>

            <a href="#" class="menu-item" onclick="openModal('userManagementModal'); return false;">
                <i class="fas fa-users-cog"></i>
                <span class="menu-text">User Management</span>
            </a>

            <a href="#" class="menu-item" onclick="openSystemSettings(); return false;">
                <i class="fas fa-cog"></i>
                <span class="menu-text">Settings</span>
            </a>
        </div>
    </div>

    <!-- Right Icon Rail -->
    <div class="right-rail">
        <div class="rail-icon" title="Notifications" onclick="showNotificationsPanel()">
            <i class="fas fa-bell"></i>
            <span class="badge" id="railNotificationsBadge" style="display: none;">0</span>
        </div>
        <div class="rail-icon" title="Messages" onclick="showMessagesSection()">
            <i class="fas fa-envelope"></i>
            <span class="badge" id="railMessagesBadge" style="display: none;">0</span>
        </div>
        <div class="rail-icon" title="Calendar" onclick="showAcademicCalendarModal()">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="rail-icon" title="Admissions" onclick="openModal('admissionsModal'); loadAdmissions()">
            <i class="fas fa-user-graduate"></i>
            <span class="badge" id="railAdmissionsBadge" style="display: none;">0</span>
        </div>
        <div class="rail-divider"></div>
        <div class="rail-icon" title="Teachers" onclick="showTeachersSection()">
            <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div class="rail-icon" title="Gallery" onclick="showGallerySection()">
            <i class="fas fa-images"></i>
        </div>
        <div class="rail-icon" title="Library" onclick="openModal('libraryModal')">
            <i class="fas fa-book"></i>
        </div>
        <div class="rail-icon" title="User Management" onclick="openModal('userManagementModal')">
            <i class="fas fa-users-cog"></i>
        </div>
        <div class="rail-divider"></div>
        <div class="rail-icon" title="Help" onclick="showHelpPanel()">
            <i class="fas fa-question-circle"></i>
        </div>
        <div class="rail-icon" title="Settings" onclick="openSystemSettings()">
            <i class="fas fa-cog"></i>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title">
                    <h1><i class="fas fa-home"></i> Dashboard</h1>
                </div>
            </div>

            <div class="top-bar-center">
                <!-- Date Time Card -->
                <div class="datetime-card">
                    <div class="datetime-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="date-section">
                        <div class="date">
                            <span id="currentDate">Loading...</span>
                        </div>
                        <div class="time" id="currentTime">00:00:00</div>
                    </div>
                </div>

                <!-- Greeting Card -->
                <div class="greeting-card">
                    <div class="greeting-icon">
                        <i class="fas fa-hand-sparkles"></i>
                    </div>
                    <div class="greeting-content">
                        <div class="greeting-text" id="greetingText">Good Morning</div>
                        <div class="greeting-name" id="greetingName">Welcome back!</div>
                    </div>
                </div>
            </div>

            <div class="top-bar-right">
                <div class="top-bar-icon">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <div class="top-bar-icon">
                    <i class="fas fa-envelope"></i>
                    <span class="badge">5</span>
                </div>
                <div class="top-bar-icon" onclick="openSystemSettings()">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="user-profile" onclick="toggleUserDropdown(event)">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="name" id="userName">Loading...</div>
                        <div class="role" id="userRole">...</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 12px; color: var(--text-gray);"></i>
                </div>
                
                <!-- Dropdown Menu (outside user-profile for proper positioning) -->
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-header">
                        <div class="avatar-large" id="userAvatarLarge">A</div>
                        <div class="name" id="userNameDropdown">Administrator</div>
                        <div class="email" id="userEmailDropdown">admin@stlawrence.edu</div>
                    </div>
                    <div class="user-dropdown-menu">
                        <a href="#" class="user-dropdown-item" onclick="openProfileSettings(); return false;">
                            <i class="fas fa-user"></i>
                            <span>My Profile</span>
                        </a>
                        <a href="#" class="user-dropdown-item" onclick="openAccountSettings(); return false;">
                            <i class="fas fa-cog"></i>
                            <span>Account Settings</span>
                        </a>
                        <a href="#" class="user-dropdown-item" onclick="openChangePassword(); return false;">
                            <i class="fas fa-key"></i>
                            <span>Change Password</span>
                        </a>
                        <div class="user-dropdown-divider"></div>
                        <a href="#" class="user-dropdown-item" onclick="openSystemSettings(); return false;">
                            <i class="fas fa-sliders-h"></i>
                            <span>System Settings</span>
                        </a>
                        <a href="#" class="user-dropdown-item" onclick="viewActivityLog(); return false;">
                            <i class="fas fa-history"></i>
                            <span>Activity Log</span>
                        </a>
                        <div class="user-dropdown-divider"></div>
                        <a href="#" class="user-dropdown-item" style="color: #dc3545;" onclick="logout(); return false;">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
                
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div class="header-content">
                    <div class="header-left">
                        <h2><i class="fas fa-chart-line"></i> Dashboard Overview</h2>
                        <p>Monitor your school's performance and activities in real-time</p>
                    </div>
                    <div class="header-right">
                        <button class="header-action-btn secondary">
                            <i class="fas fa-download"></i>
                            Export Report
                        </button>
                        <button class="header-action-btn">
                            <i class="fas fa-plus"></i>
                            Quick Add
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-header">
                        <div class="stat-title">TOTAL STUDENTS</div>
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-footer">
                        <span>P.1 to P.7 Students</span>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            <span>0 New</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card red">
                    <div class="stat-header">
                        <div class="stat-title">TOTAL TEACHERS</div>
                        <div class="stat-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalTeachers">0</div>
                    <div class="stat-footer">
                        <span>P.1 to P.7 Teachers</span>
                        <div class="stat-change">
                            <i class="fas fa-minus"></i>
                            <span>0 Inactive</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card green">
                    <div class="stat-header">
                        <div class="stat-title">ATTENDANCE RATE</div>
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-value">0%</div>
                    <div class="stat-footer">
                        <span>Today's Attendance</span>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            <span>0 Absent</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card purple">
                    <div class="stat-header">
                        <div class="stat-title">REVENUE THIS MONTH</div>
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-value">$0</div>
                    <div class="stat-footer">
                        <span>From 0 Payments</span>
                        <div class="stat-change">
                            <i class="fas fa-arrow-up"></i>
                            <span>0 Collected</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout: Student Distribution + Upcoming Events -->
            <div class="two-column-layout" style="margin-bottom: 25px;">
                <!-- Left Column: Student Distribution -->
                <div class="left-column">
                    <div class="chart-section">
                        <div class="section-header">
                            <h3><i class="fas fa-chart-pie"></i> Student Distribution</h3>
                            <select class="chart-filter">
                                <option>This Year</option>
                                <option>Last Year</option>
                                <option>All Time</option>
                            </select>
                        </div>
                        <canvas id="studentChart"></canvas>
                    </div>
                </div>

                <!-- Right Column: Upcoming Events -->
                <div class="right-column">
                    <div class="upcoming-events">
                        <div class="section-header">
                            <h3><i class="fas fa-calendar-alt"></i> Upcoming Events</h3>
                            <a href="#" class="view-all">View All</a>
                        </div>
                        <div class="events-list">
                            <div class="event-item">
                                <div class="event-date">
                                    <div class="event-day">15</div>
                                    <div class="event-month">JAN</div>
                                </div>
                                <div class="event-details">
                                    <div class="event-title">Sports Day</div>
                                    <div class="event-time"><i class="fas fa-clock"></i> 9:00 AM - 4:00 PM</div>
                                </div>
                            </div>
                            <div class="event-item">
                                <div class="event-date">
                                    <div class="event-day">20</div>
                                    <div class="event-month">JAN</div>
                                </div>
                                <div class="event-details">
                                    <div class="event-title">Parent Meeting</div>
                                    <div class="event-time"><i class="fas fa-clock"></i> 2:00 PM - 5:00 PM</div>
                                </div>
                            </div>
                            <div class="event-item">
                                <div class="event-date">
                                    <div class="event-day">25</div>
                                    <div class="event-month">JAN</div>
                                </div>
                                <div class="event-details">
                                    <div class="event-title">Science Fair</div>
                                    <div class="event-time"><i class="fas fa-clock"></i> 10:00 AM - 3:00 PM</div>
                                </div>
                            </div>
                            <div class="event-item">
                                <div class="event-date">
                                    <div class="event-day">28</div>
                                    <div class="event-month">JAN</div>
                                </div>
                                <div class="event-details">
                                    <div class="event-title">Music Concert</div>
                                    <div class="event-time"><i class="fas fa-clock"></i> 6:00 PM - 8:00 PM</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout: Recent Activity + Calendar -->
            <div class="two-column-layout">
                <!-- Left Column: Recent Activity -->
                <div class="left-column">
                    <div class="activity-section">
                        <div class="section-header">
                            <h3><i class="fas fa-history"></i> Recent Activity</h3>
                            <a href="#" class="view-all">View All</a>
                        </div>
                        <div class="activity-timeline">
                            <div style="text-align: center; padding: 40px 20px; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Loading activities...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Calendar -->
                <div class="right-column">
                    <div class="calendar-widget">
                        <div class="section-header">
                            <h3><i class="fas fa-calendar"></i> Calendar</h3>
                        </div>
                        <div class="calendar-mini">
                            <div class="calendar-header">
                                <button class="calendar-nav"><i class="fas fa-chevron-left"></i></button>
                                <span class="calendar-month" id="calendarMonth">January 2026</span>
                                <button class="calendar-nav"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendar-days">
                                <div class="calendar-day-name">Sun</div>
                                <div class="calendar-day-name">Mon</div>
                                <div class="calendar-day-name">Tue</div>
                                <div class="calendar-day-name">Wed</div>
                                <div class="calendar-day-name">Thu</div>
                                <div class="calendar-day-name">Fri</div>
                                <div class="calendar-day-name">Sat</div>
                            </div>
                            <div class="calendar-dates" id="calendarDates">
                                <!-- Calendar dates will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions (Full Width) -->
            <div class="quick-actions">
                <div class="section-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="actions-grid">
                    <a href="#" class="action-card" data-module="content" data-permission="content.teacher.manage" onclick="showTeachersSection(); return false;">
                        <div class="action-icon blue">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="action-content">
                            <h4>Add New Teacher</h4>
                            <p>Register and onboard new teaching staff members</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="#" class="action-card" data-module="content" data-permission="content.event.manage" onclick="showEventsModal(); return false;">
                        <div class="action-icon red">
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <div class="action-content">
                            <h4>Create Event</h4>
                            <p>Schedule and organize upcoming school events</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="#" class="action-card" data-module="library" data-permission="library.upload" onclick="openModal('libraryModal'); return false;">
                        <div class="action-icon green">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="action-content">
                            <h4>Upload Resources</h4>
                            <p>Add educational PDFs and materials to library</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="#" class="action-card" data-module="admissions" data-permission="admission.view" onclick="openModal('admissionsModal'); loadAdmissions(); return false;">
                        <div class="action-icon purple">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="action-content">
                            <h4>Manage Admissions <span class="notification-badge" id="admissionsBadgeQuick" style="display: none; margin-left: 8px;">0</span></h4>
                            <p>View and manage student admission applications</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="#" class="action-card" data-module="content" data-permission="content.gallery.manage" onclick="showGallerySection(); return false;">
                        <div class="action-icon orange">
                            <i class="fas fa-images"></i>
                        </div>
                        <div class="action-content">
                            <h4>Upload Photos</h4>
                            <p>Add images to school gallery and albums</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>

                    <a href="#" class="action-card" data-module="communications" data-permission="comm.message.view" onclick="showMessagesSection(); return false;">
                        <div class="action-icon blue">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="action-content">
                            <h4>View Messages <span class="notification-badge" id="messagesBadgeQuick" style="display: none; margin-left: 8px;">0</span></h4>
                            <p>Read and reply to contact form submissions</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a>
                </div>
            </div>
                        </div>
                        <div class="action-content">
                            <h4>Add Testimonial</h4>
                            <p>Add parent/student feedback</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a> -->

                    <!-- <a href="#" class="action-card">
                        <div class="action-icon orange">
                            <i class="fas fa-images"></i>
                        </div>
                        <div class="action-content">
                            <h4>Upload Photos</h4>
                            <p>Add to gallery</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a> -->

                    <!-- <a href="#" class="action-card">
                        <div class="action-icon green">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="action-content">
                            <h4>Manage Library</h4>
                            <p>Update and organize library books catalog</p>
                        </div>
                        <div class="action-link">
                            Get Started <i class="fas fa-arrow-right"></i>
                        </div>
                    </a> -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Event Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-plus"></i> Add New Event</h3>
                <button class="modal-close" onclick="closeModal('eventModal')">&times;</button>
            </div>
            <form id="eventForm" onsubmit="submitEvent(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Event Title *</label>
                        <input type="text" name="event_title" required class="form-control">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Event Date *</label>
                            <input type="date" name="event_date" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Category *</label>
                            <select name="category" required class="form-control">
                                <option value="">Select Category</option>
                                <option value="academic">Academic</option>
                                <option value="important_day">Important Day</option>
                                <option value="sports">Sports</option>
                                <option value="cultural">Cultural</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" name="start_time" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>End Time *</label>
                            <input type="time" name="end_time" required class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <input type="text" name="location" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="event_description" rows="3" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Event
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Testimonial Modal -->
    <div class="modal" id="testimonialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-quote-left"></i> Add New Testimonial</h3>
                <button class="modal-close" onclick="closeModal('testimonialModal')">&times;</button>
            </div>
            <form id="testimonialForm" onsubmit="submitTestimonial(event)" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" name="parent_name" required class="form-control" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label>Testimonial Type *</label>
                            <select name="testimonial_type" required class="form-control">
                                <option value="">Select Type</option>
                                <option value="parent">Parent</option>
                                <option value="student">Student</option>
                                <option value="old_student">Old Student</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Testimonial Text *</label>
                        <textarea name="testimonial_text" rows="4" required class="form-control" placeholder="Share your experience..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Rating *</label>
                        <select name="rating" required class="form-control">
                            <option value="5">5 Stars - Excellent</option>
                            <option value="4">4 Stars - Very Good</option>
                            <option value="3">3 Stars - Good</option>
                            <option value="2">2 Stars - Fair</option>
                            <option value="1">1 Star - Poor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Photo (optional)</label>
                        <input type="file" name="photo" class="form-control" accept="image/*">
                        <small style="color: #9ca3af; font-size: 12px; margin-top: 5px; display: block;">Upload a photo (JPG, PNG, max 100MB)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('testimonialModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Testimonial
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Important Day Modal -->
    <div class="modal" id="importantDayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-star"></i> Add Important Day</h3>
                <button class="modal-close" onclick="closeModal('importantDayModal')">&times;</button>
            </div>
            <form id="importantDayForm" onsubmit="submitImportantDay(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Event Title *</label>
                        <input type="text" name="event_title" required class="form-control" placeholder="e.g., Independence Day">
                    </div>
                    <div class="form-group">
                        <label>Event Date *</label>
                        <input type="date" name="start_date" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Event Type *</label>
                        <select name="event_type" required class="form-control">
                            <option value="holiday">Holiday</option>
                            <option value="activity">Activity</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="event_description" rows="3" class="form-control" placeholder="Brief description of the important day"></textarea>
                    </div>
                    <input type="hidden" name="all_day" value="1">
                    <input type="hidden" name="color" value="#dc3545">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('importantDayModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Important Day
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Academic Calendar Event Modal -->
    <div class="modal" id="academicCalendarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> Add Academic Calendar Event</h3>
                <button class="modal-close" onclick="closeModal('academicCalendarModal')">&times;</button>
            </div>
            <form id="academicCalendarForm" onsubmit="submitAcademicCalendar(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Event Title *</label>
                        <input type="text" name="event_title" required class="form-control" placeholder="e.g., Term 1 Opening">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Event Date *</label>
                            <input type="date" name="start_date" required class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Event Type *</label>
                            <select name="event_type" required class="form-control">
                                <option value="">Select Type</option>
                                <option value="exam">Examination</option>
                                <option value="meeting">Meeting</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="event_description" rows="3" class="form-control" placeholder="Details about this academic event"></textarea>
                    </div>
                    <input type="hidden" name="all_day" value="1">
                    <input type="hidden" name="color" value="#0066cc">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('academicCalendarModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Academic Event
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reply to Message Modal -->
    <div class="modal" id="replyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-reply"></i> Reply to Message</h3>
                <button class="modal-close" onclick="closeModal('replyModal')">&times;</button>
            </div>
            <form id="replyForm" onsubmit="submitReply(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Original Message</label>
                        <div id="originalMessage" style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px;">
                            <!-- Original message will be displayed here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Your Reply *</label>
                        <textarea name="reply_message" rows="6" required class="form-control" placeholder="Type your reply here..."></textarea>
                    </div>
                    <input type="hidden" name="submission_id" id="replySubmissionId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('replyModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Loading Overlay -->
    <div class="modal-loading-overlay" id="modalLoadingOverlay">
        <div class="modal-loading-content">
            <div id="modalLoader"></div>
            <div class="modal-loading-title" id="modalLoadingTitle">Loading...</div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div class="modal modal-large" id="messagesModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h3><i class="fas fa-envelope"></i> Contact Messages</h3>
                <button class="modal-close" onclick="closeModal('messagesModal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="messages-container">
                    <div class="messages-list" id="messagesList">
                        <!-- Loader -->
                        <div class="advanced-loader">
                            <div class="loader-spinner"></div>
                            <div class="loader-text">Loading messages...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div class="modal modal-large" id="galleryModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h3><i class="fas fa-images"></i> Gallery Management</h3>
                <button class="modal-close" onclick="closeModal('galleryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Upload Form -->
                <div class="form-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 2px dashed #0066cc;">
                    <h4 style="margin-bottom: 25px; color: #0066cc; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Images
                    </h4>
                    <form id="galleryUploadForm" onsubmit="submitGalleryImages(event)" enctype="multipart/form-data">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 12px; display: block;">
                                Select Images (Max 100MB each, Multiple files allowed)
                            </label>
                            <input type="file" name="images[]" accept="image/*" required multiple
                                   style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.3s;"
                                   onchange="previewGalleryImages(this)">
                            <small style="color: #666; display: block; margin-top: 8px; font-size: 13px;">
                                <i class="fas fa-info-circle"></i> Supported formats: JPG, PNG, GIF, WEBP | Hold Ctrl/Cmd to select multiple images
                            </small>
                        </div>
                        
                        <!-- Images Preview -->
                        <div id="galleryImagesPreview" style="display: none; margin-top: 20px;">
                            <h5 style="margin-bottom: 15px; color: #333; font-size: 14px; font-weight: 600;">
                                <i class="fas fa-images"></i> Selected Images (<span id="imageCount">0</span>)
                            </h5>
                            <div id="previewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;"></div>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 25px; padding: 15px; font-size: 16px; font-weight: 600;">
                            <i class="fas fa-upload"></i> Upload Images
                        </button>
                    </form>
                </div>
                
                <!-- Gallery Images List -->
                <div class="gallery-images-section">
                    <h4 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-th"></i> Uploaded Images
                    </h4>
                    <div id="galleryImagesList">
                        <!-- Loader -->
                        <div class="advanced-loader">
                            <div class="loader-spinner"></div>
                            <div class="loader-text">Loading gallery images...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teachers Modal -->
    <div class="modal modal-large" id="teachersModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h3><i class="fas fa-chalkboard-teacher"></i> Teachers Management</h3>
                <button class="modal-close" onclick="closeModal('teachersModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Add Teacher Form -->
                <div class="form-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 2px dashed #0066cc;">
                    <h4 style="margin-bottom: 25px; color: #0066cc; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-user-plus"></i> Add New Teacher
                    </h4>
                    <form id="teacherForm" onsubmit="submitTeacher(event)" enctype="multipart/form-data">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Full Name *</label>
                                <input type="text" name="full_name" required placeholder="Enter teacher's full name"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Department *</label>
                                <select name="department" required
                                        style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; background: white; cursor: pointer;"
                                        onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                        onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    <option value="">Select Department</option>
                                    <option value="administration">Administration</option>
                                    <option value="english">English</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="science">Science</option>
                                    <option value="social">Social Studies</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Position</label>
                                <input type="text" name="position" placeholder="e.g., Head Teacher, Senior Teacher"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Qualification</label>
                                <input type="text" name="qualification" placeholder="e.g., Bachelor of Education"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Experience (Years)</label>
                                <input type="number" name="experience_years" min="0" placeholder="Years of experience"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Email</label>
                                <input type="email" name="email" placeholder="teacher@example.com"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Phone</label>
                                <input type="tel" name="phone" placeholder="+256 XXX XXX XXX"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="color: #333; font-weight: 600;">Bio / About</label>
                            <textarea name="bio" rows="3" placeholder="Brief information about the teacher"
                                      style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; font-family: inherit; resize: vertical;"
                                      onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                      onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="color: #333; font-weight: 600;">Specialization / Subjects</label>
                            <input type="text" name="specialization" placeholder="e.g., Primary Mathematics, English Literature"
                                   style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                   onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                   onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="color: #333; font-weight: 600;">Photo (Max 100MB)</label>
                            <input type="file" name="photo" accept="image/*" onchange="previewTeacherPhoto(this)"
                                   style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Supported formats: JPG, PNG, GIF, WEBP
                            </small>
                        </div>
                        
                        <!-- Photo Preview -->
                        <div id="teacherPhotoPreview" style="display: none; margin-bottom: 20px; text-align: center;">
                            <img id="previewTeacherImg" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        </div>
                        
                        <button type="submit" class="btn-primary" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,102,204,0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-user-plus"></i> Add Teacher
                        </button>
                    </form>
                </div>
                
                <!-- Teachers List -->
                <div class="teachers-list-section">
                    <h4 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-users"></i> All Teachers
                    </h4>
                    <div id="teachersList">
                        <!-- Loader -->
                        <div class="advanced-loader">
                            <div class="loader-spinner"></div>
                            <div class="loader-text">Loading teachers...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Modal -->
    <div class="modal modal-large" id="libraryModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> Library Management</h3>
                <button class="modal-close" onclick="closeModal('libraryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Upload Form -->
                <div class="form-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; border: 2px dashed #0066cc;">
                    <h4 style="margin-bottom: 25px; color: #0066cc; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Resource
                    </h4>
                    <form id="libraryForm" onsubmit="submitLibraryResources(event)" enctype="multipart/form-data">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="color: #333; font-weight: 600;">Files * (Max 100MB each)</label>
                            <input type="file" name="files[]" multiple required
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.mp4"
                                   onchange="previewLibraryFiles(this)"
                                   style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> Supported: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG, MP4 | You can select multiple files
                            </small>
                        </div>
                        
                        <!-- Files Preview -->
                        <div id="libraryFilesPreview" style="display: none; margin-bottom: 20px;">
                            <h5 style="margin-bottom: 15px; color: #333; font-size: 14px; font-weight: 600;">
                                <i class="fas fa-files"></i> Selected Files (<span id="fileCount">0</span>)
                            </h5>
                            <div id="filesPreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Title</label>
                                <input type="text" name="title" placeholder="Enter resource title (optional)"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Category</label>
                                <select name="category"
                                        style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; background: white; cursor: pointer;"
                                        onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                        onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    <option value="">Select Category (optional)</option>
                                    <option value="assignment">Assignment</option>
                                    <option value="reading">Reading Material</option>
                                    <option value="past_exam">Past Exam</option>
                                    <option value="revision">Revision Notes</option>
                                    <option value="multimedia">Multimedia</option>
                                    <option value="study_guide">Study Guide</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Class Level</label>
                                <select name="class_level"
                                        style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; background: white; cursor: pointer;"
                                        onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                        onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    <option value="">Select Class (optional)</option>
                                    <option value="all">All Classes</option>
                                    <option value="p1">Primary 1</option>
                                    <option value="p2">Primary 2</option>
                                    <option value="p3">Primary 3</option>
                                    <option value="p4">Primary 4</option>
                                    <option value="p5">Primary 5</option>
                                    <option value="p6">Primary 6</option>
                                    <option value="p7">Primary 7</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Subject</label>
                                <input type="text" name="subject" placeholder="e.g., Mathematics, English"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                            
                            <div class="form-group">
                                <label style="color: #333; font-weight: 600;">Upload Date</label>
                                <input type="date" name="upload_date" value="<?php echo date('Y-m-d'); ?>"
                                       style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="color: #333; font-weight: 600;">Description</label>
                            <textarea name="description" rows="3" placeholder="Brief description of the resource (optional)"
                                      style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; font-family: inherit; resize: vertical;"
                                      onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'"
                                      onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,102,204,0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-upload"></i> Upload Resources
                        </button>
                    </form>
                </div>
                
                <!-- Resources List -->
                <div class="library-resources-section">
                    <h4 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-books"></i> All Resources
                    </h4>
                    <div id="libraryResourcesList">
                        <!-- Loader -->
                        <div class="advanced-loader">
                            <div class="loader-spinner"></div>
                            <div class="loader-text">Loading resources...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admissions Modal -->
    <div class="modal modal-large" id="admissionsModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header" style="background:linear-gradient(135deg,#0066cc 0%,#0052a3 100%);color:white;padding:24px 30px;">
                <h3 style="margin:0;font-size:22px;font-weight:700;"><i class="fas fa-user-graduate"></i> Admissions Management</h3>
                <button class="modal-close" onclick="closeModal('admissionsModal')" style="color:white;font-size:28px;">&times;</button>
            </div>
            <div class="modal-body" style="padding:30px;background:#f8fafc;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                    <h4 style="margin:0;color:#1e293b;font-size:18px;font-weight:600;display:flex;align-items:center;gap:10px;">
                        <i class="fas fa-list" style="color:#0066cc;"></i> All Applications
                    </h4>
                    <div style="background:white;padding:8px 16px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                        <span style="color:#64748b;font-size:13px;font-weight:600;">Total: <span id="totalApplications" style="color:#0066cc;font-weight:700;">0</span></span>
                    </div>
                </div>
                <div id="admissionsList"></div>
            </div>
        </div>
    </div>

    <!-- View Admission Modal -->
    <div class="modal modal-large" id="viewAdmissionModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header" style="background:linear-gradient(135deg,#0066cc 0%,#0052a3 100%);color:white;padding:24px 30px;">
                <h3 style="margin:0;font-size:22px;font-weight:700;"><i class="fas fa-eye"></i> Application Details</h3>
                <button class="modal-close" onclick="closeModal('viewAdmissionModal')" style="color:white;font-size:28px;">&times;</button>
            </div>
            <div class="modal-body" id="viewAdmissionContent" style="background:#f8fafc;"></div>
        </div>
    </div>

    <!-- Edit Admission Modal -->
    <div class="modal modal-large" id="editAdmissionModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header" style="background:linear-gradient(135deg,#0066cc 0%,#0052a3 100%);color:white;padding:24px 30px;">
                <h3 style="margin:0;font-size:22px;font-weight:700;"><i class="fas fa-edit"></i> Edit Application</h3>
                <button class="modal-close" onclick="closeModal('editAdmissionModal')" style="color:white;font-size:28px;">&times;</button>
            </div>
            <div class="modal-body" style="padding:30px;background:#f8fafc;max-height:70vh;overflow-y:auto;">
                <form id="editAdmissionForm" onsubmit="submitEditAdmission(event)">
                    <input type="hidden" id="editAdmissionId" name="id">
                    
                    <!-- Student Information -->
                    <h4 style="color:#0066cc;margin:0 0 20px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
                        <i class="fas fa-user-graduate"></i> Student Information
                    </h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">First Name *</label>
                            <input type="text" name="student_first_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Last Name *</label>
                            <input type="text" name="student_last_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Date of Birth *</label>
                            <input type="date" name="date_of_birth" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Gender *</label>
                            <select name="gender" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Nationality *</label>
                            <input type="text" name="nationality" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Religion</label>
                            <input type="text" name="religion" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Class to Join *</label>
                            <input type="text" name="class_to_join" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Admission Type *</label>
                            <select name="admission_type" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                <option value="day">Day</option>
                                <option value="boarding">Boarding</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Parent Information -->
                    <h4 style="color:#0066cc;margin:0 0 20px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
                        <i class="fas fa-users"></i> Parent/Guardian Information
                    </h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">First Name *</label>
                            <input type="text" name="parent_first_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Last Name *</label>
                            <input type="text" name="parent_last_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Relationship *</label>
                            <input type="text" name="parent_relationship" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Phone *</label>
                            <input type="tel" name="parent_phone" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Email</label>
                            <input type="email" name="parent_email" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Occupation</label>
                            <input type="text" name="parent_occupation" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div style="grid-column:1/-1;">
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Address</label>
                            <textarea name="parent_address" rows="2" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'"></textarea>
                        </div>
                    </div>
                    
                    <!-- Emergency Contact -->
                    <h4 style="color:#0066cc;margin:0 0 20px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
                        <i class="fas fa-phone-alt"></i> Emergency Contact
                    </h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:30px;">
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Name *</label>
                            <input type="text" name="emergency_contact_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Relationship *</label>
                            <input type="text" name="emergency_contact_relationship" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Phone *</label>
                            <input type="tel" name="emergency_contact_phone" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                    </div>
                    
                    <!-- Document Uploads -->
                    <h4 style="color:#0066cc;margin:0 0 20px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
                        <i class="fas fa-file-upload"></i> Update Documents (Optional - Leave empty to keep existing)
                    </h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Birth Certificate</label>
                            <input type="file" name="birth_certificate" accept=".pdf,.jpg,.jpeg,.png" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;">
                            <p id="currentBirthCert" style="margin:6px 0 0 0;font-size:12px;color:#64748b;"></p>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Passport Photo</label>
                            <input type="file" name="passport_photo" accept=".jpg,.jpeg,.png" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;">
                            <p id="currentPassportPhoto" style="margin:6px 0 0 0;font-size:12px;color:#64748b;"></p>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Previous School Report</label>
                            <input type="file" name="previous_school_report" accept=".pdf,.jpg,.jpeg,.png" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;">
                            <p id="currentPreviousReport" style="margin:6px 0 0 0;font-size:12px;color:#64748b;"></p>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Immunization Record</label>
                            <input type="file" name="immunization_record" accept=".pdf,.jpg,.jpeg,.png" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;">
                            <p id="currentImmunization" style="margin:6px 0 0 0;font-size:12px;color:#64748b;"></p>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Parent ID</label>
                            <input type="file" name="parent_id" accept=".pdf,.jpg,.jpeg,.png" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;">
                            <p id="currentParentId" style="margin:6px 0 0 0;font-size:12px;color:#64748b;"></p>
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Transfer Letter</label>
                            <input type="file" name="transfer_letter" accept=".pdf,.jpg,.jpeg,.png" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;">
                            <p id="currentTransferLetter" style="margin:6px 0 0 0;font-size:12px;color:#64748b;"></p>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:2px solid #e2e8f0;">
                        <button type="button" onclick="closeModal('editAdmissionModal')" style="padding:12px 24px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" style="padding:12px 24px;background:#0066cc;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal modal-large" id="userManagementModal">
        <div class="modal-content modal-content-large">
            <div class="modal-header" style="background:linear-gradient(135deg,#0066cc 0%,#0052a3 100%);color:white;padding:24px 30px;">
                <h3 style="margin:0;font-size:22px;font-weight:700;"><i class="fas fa-users-cog"></i> User Management</h3>
                <button class="modal-close" onclick="closeModal('userManagementModal')" style="color:white;font-size:28px;">&times;</button>
            </div>
            <div class="modal-body" style="padding:30px;background:#f8fafc;max-height:75vh;overflow-y:auto;">
                
                <!-- Add New User Section -->
                <div style="background:white;padding:25px;border-radius:12px;margin-bottom:30px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                    <h4 style="color:#0066cc;margin:0 0 20px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
                        <i class="fas fa-user-plus"></i> Add New User
                    </h4>
                    <form id="addUserForm" onsubmit="submitAddUser(event)">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Username *</label>
                                <input type="text" name="username" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Full Name *</label>
                                <input type="text" name="full_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Email *</label>
                                <input type="email" name="email" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Role *</label>
                                <select name="role_id" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                    <option value="">Select Role</option>
                                    <option value="1">Super Admin</option>
                                    <option value="2">Admin</option>
                                    <option value="3">Editor</option>
                                    <option value="4">Viewer</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Password *</label>
                                <input type="password" name="password" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Confirm Password *</label>
                                <input type="password" name="confirm_password" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                            </div>
                        </div>
                        <div style="display:flex;gap:12px;justify-content:flex-end;">
                            <button type="reset" style="padding:12px 24px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <button type="submit" style="padding:12px 24px;background:#0066cc;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                                <i class="fas fa-user-plus"></i> Add User
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Existing Users List -->
                <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                    <h4 style="color:#0066cc;margin:0 0 20px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:2px solid #e2e8f0;">
                        <i class="fas fa-users"></i> Existing Users
                    </h4>
                    
                    <!-- Search and Filter -->
                    <div style="display:flex;gap:15px;margin-bottom:20px;">
                        <div style="flex:1;">
                            <input type="text" id="userSearchInput" placeholder="Search by username, name, or email..." style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;" oninput="filterUsers()">
                        </div>
                        <div style="width:200px;">
                            <select id="roleFilterSelect" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="1">Super Admin</option>
                                <option value="2">Admin</option>
                                <option value="3">Editor</option>
                                <option value="4">Viewer</option>
                            </select>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                                    <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#475569;">Username</th>
                                    <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#475569;">Full Name</th>
                                    <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#475569;">Email</th>
                                    <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#475569;">Role</th>
                                    <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#475569;">Status</th>
                                    <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#475569;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="6" style="padding:40px;text-align:center;color:#94a3b8;">
                                        <i class="fas fa-spinner fa-spin" style="font-size:24px;margin-bottom:10px;"></i>
                                        <p style="margin:0;">Loading users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header" style="background:linear-gradient(135deg,#0066cc 0%,#0052a3 100%);color:white;padding:24px 30px;">
                <h3 style="margin:0;font-size:20px;font-weight:700;"><i class="fas fa-user-edit"></i> Edit User</h3>
                <button class="modal-close" onclick="closeModal('editUserModal')" style="color:white;font-size:28px;">&times;</button>
            </div>
            <div class="modal-body" style="padding:30px;background:#f8fafc;">
                <form id="editUserForm" onsubmit="submitEditUser(event)">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Username *</label>
                            <input type="text" id="editUsername" name="username" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Full Name *</label>
                            <input type="text" id="editFullName" name="full_name" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Email *</label>
                            <input type="email" id="editEmail" name="email" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Role *</label>
                            <select id="editRoleId" name="role_id" required style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                <option value="1">Super Admin</option>
                                <option value="2">Admin</option>
                                <option value="3">Editor</option>
                                <option value="4">Viewer</option>
                            </select>
                        </div>
                    </div>
                    <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:15px;margin-bottom:20px;">
                        <p style="margin:0;font-size:13px;color:#856404;"><i class="fas fa-info-circle"></i> Leave password fields empty to keep the current password</p>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">New Password</label>
                            <input type="password" id="editPassword" name="password" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                        <div>
                            <label style="display:block;margin-bottom:6px;color:#475569;font-weight:600;font-size:13px;">Confirm New Password</label>
                            <input type="password" id="editConfirmPassword" name="confirm_password" style="width:100%;padding:12px 15px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;transition:all 0.2s;" onfocus="this.style.borderColor='#0066cc';this.style.boxShadow='0 0 0 3px rgba(0,102,204,0.1)'" onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                        </div>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:2px solid #e2e8f0;">
                        <button type="button" onclick="closeModal('editUserModal')" style="padding:12px 24px;background:#6c757d;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" style="padding:12px 24px;background:#0066cc;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        checkAuth();

        // Fallback: Hide loading screen after 3 seconds if still showing
        setTimeout(() => {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen && loadingScreen.style.display !== 'none') {
                console.warn('Loading screen timeout - forcing hide');
                loadingScreen.style.display = 'none';
            }
        }, 3000);

        // Welcome Popup Function
        function showWelcomePopup(userData) {
            const fullName = userData.full_name || userData.username;
            const roleName = userData.role_name || 'User';
            const currentHour = new Date().getHours();
            
            // Determine greeting based on time of day
            let greeting = 'Good Evening';
            let greetingIcon = '';
            if (currentHour < 12) {
                greeting = 'Good Morning';
                greetingIcon = '';
            } else if (currentHour < 18) {
                greeting = 'Good Afternoon';
                greetingIcon = '';
            }
            
            // Get role-specific welcome message
            let roleMessage = '';
            let roleIcon = '';
            
            switch(roleName) {
                case 'Super Administrator':
                    roleMessage = 'You have full system access. Manage the school with complete control.';
                    roleIcon = '';
                    break;
                case 'Administrator':
                    roleMessage = 'Welcome back! You have administrative access to manage the school.';
                    roleIcon = '';
                    break;
                case 'Teacher':
                    roleMessage = 'Ready to inspire young minds? Access your classes and student records.';
                    roleIcon = '';
                    break;
                case 'Accountant':
                    roleMessage = 'Manage school finances, fees, and generate financial reports.';
                    roleIcon = '';
                    break;
                case 'Librarian':
                    roleMessage = 'Manage library resources and help students access learning materials.';
                    roleIcon = '';
                    break;
                case 'Receptionist':
                    roleMessage = 'Handle admissions, messages, and front desk operations.';
                    roleIcon = '';
                    break;
                case 'Parent':
                    roleMessage = 'View your children\'s progress, attendance, and school updates.';
                    roleIcon = '';
                    break;
                case 'Student':
                    roleMessage = 'Access your academic records, library resources, and school events.';
                    roleIcon = '';
                    break;
                default:
                    roleMessage = 'Welcome to St. Lawrence Junior School Management System.';
                    roleIcon = '';
            }
            
            // Show welcome popup
            Swal.fire({
                title: `${greetingIcon} ${greeting}, ${fullName}!`,
                html: `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">${roleIcon}</div>
                        <h3 style="color: #0066cc; margin-bottom: 15px; font-size: 20px; font-weight: 600;">
                            ${roleName}
                        </h3>
                        <p style="color: #475569; font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                            ${roleMessage}
                        </p>
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 15px; border-radius: 10px; border-left: 4px solid #0066cc;">
                            <p style="margin: 0; color: #0369a1; font-size: 14px; font-weight: 500;">
                                <i class="fas fa-info-circle"></i> 
                                ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>
                        </div>
                    </div>
                `,
                icon: 'success',
                iconColor: '#0066cc',
                confirmButtonText: 'Let\'s Get Started! ',
                confirmButtonColor: '#0066cc',
                showClass: {
                    popup: 'animate__animated animate__fadeInDown animate__faster'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutUp animate__faster'
                },
                backdrop: `
                    rgba(0, 0, 0, 0.4)
                    left top
                    no-repeat
                `,
                allowOutsideClick: false,
                allowEscapeKey: true,
                timer: 8000,
                timerProgressBar: true,
                didOpen: (popup) => {
                    // Add custom styling
                    popup.style.borderRadius = '20px';
                    popup.style.padding = '10px';
                }
            });
        }

        async function checkAuth() {
            try {
                const response = await fetch('../api/auth/check_session.php');
                
                if (!response.ok) {
                    console.error('Session check failed with status:', response.status);
                    window.location.href = 'login.html';
                    return;
                }
                
                const data = await response.json();
                console.log('Session data:', data);

                if (!data.logged_in) {
                    window.location.href = 'login.html';
                    return;
                }

                // Display user info
                const fullName = data.data.full_name || data.data.username;
                document.getElementById('userName').textContent = fullName;
                document.getElementById('userRole').textContent = data.data.role_name || 'User';
                document.getElementById('userAvatar').textContent = fullName.charAt(0).toUpperCase();
                document.getElementById('greetingName').textContent = fullName;
                
                // Store role level in sessionStorage for permission checks
                sessionStorage.setItem('role_level', data.data.role_level || 0);

                // Load user permissions
                await loadUserPermissions();

                // Hide loading screen
                document.getElementById('loadingScreen').style.display = 'none';

                // Show welcome popup only if not shown in this session
                if (!sessionStorage.getItem('welcomeShown')) {
                    showWelcomePopup(data.data);
                    sessionStorage.setItem('welcomeShown', 'true');
                }

                // Load stats
                loadStats();

                // Start clock
                updateDateTime();
                setInterval(updateDateTime, 1000);

                // Initialize calendar
                generateCalendar();

                // Initialize student chart
                initializeStudentChart();
                
                // Load activities and events
                loadActivities();
                loadEvents();

                // Start background color rotation (moved to end of script)

            } catch (error) {
                console.error('Auth check failed:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Authentication Error',
                    text: 'Error checking authentication: ' + error.message,
                    confirmButtonColor: '#dc3545'
                });
                window.location.href = 'login.html';
            }
        }
        
        // Load user permissions and configure UI
        let userPermissions = [];
        let accessibleModules = [];
        let isSuperAdmin = false;
        
        async function loadUserPermissions() {
            try {
                const response = await fetch('../api/auth/get_permissions.php');
                const result = await response.json();
                
                if (result.success) {
                    userPermissions = result.data.permissions;
                    accessibleModules = result.data.accessible_modules;
                    isSuperAdmin = result.data.is_super_admin;
                    
                    console.log('User permissions loaded:', {
                        permissions: userPermissions,
                        modules: accessibleModules,
                        isSuperAdmin: isSuperAdmin
                    });
                    
                    // Configure UI based on permissions
                    configureUIByPermissions();
                }
            } catch (error) {
                console.error('Error loading permissions:', error);
            }
        }
        
        // Check if user has permission
        function hasPermission(permissionName) {
            if (isSuperAdmin) return true;
            if (userPermissions.includes('*')) return true;
            return userPermissions.some(p => p.permission_name === permissionName);
        }
        
        // Check if user can access module
        function canAccessModule(moduleName) {
            if (isSuperAdmin) return true;
            return accessibleModules.includes(moduleName);
        }
        
        // Configure UI based on permissions
        function configureUIByPermissions() {
            // Get user role level
            const userRoleLevel = parseInt(sessionStorage.getItem('role_level')) || 0;
            
            // Hide User Management if no access
            if (!canAccessModule('user_management')) {
                // Hide from sidebar
                const userMgmtMenuItem = document.querySelector('.menu-item[onclick*="userManagementModal"]');
                if (userMgmtMenuItem) userMgmtMenuItem.style.display = 'none';
                
                // Hide from right rail
                const userMgmtRail = document.querySelector('.rail-icon[title="User Management"]');
                if (userMgmtRail) userMgmtRail.style.display = 'none';
            }
            
            // Hide Settings if no access
            if (!canAccessModule('settings')) {
                const settingsMenuItem = document.querySelector('.menu-item[onclick*="openSystemSettings"]');
                if (settingsMenuItem) settingsMenuItem.style.display = 'none';
                
                const settingsRail = document.querySelector('.rail-icon[title="Settings"]');
                if (settingsRail) settingsRail.style.display = 'none';
            }
            
            // Hide entire Content menu and all its items for non-admin roles
            if (userRoleLevel < 80) {
                // Hide the entire Content menu item
                const contentMenuItems = document.querySelectorAll('.menu-item');
                contentMenuItems.forEach(item => {
                    const menuText = item.querySelector('.menu-text');
                    if (menuText && menuText.textContent.trim() === 'Content') {
                        item.style.display = 'none';
                        // Also hide the submenu
                        const submenu = item.nextElementSibling;
                        if (submenu && submenu.classList.contains('submenu')) {
                            submenu.style.display = 'none';
                        }
                    }
                });
                
                // Hide all content-related submenu items individually as backup
                const contentSubmenuItems = [
                    'showTeachersSection',
                    'showEventsModal',
                    'showImportantDaysModal',
                    'showAcademicCalendarModal',
                    'showLibrarySection',
                    'showGallerySection',
                    'testimonialModal',
                    'showMessagesSection'
                ];
                
                contentSubmenuItems.forEach(itemName => {
                    const item = document.querySelector(`.submenu-item[onclick*="${itemName}"]`);
                    if (item) item.style.display = 'none';
                });
                
                // Hide from right rail
                const railIcons = [
                    'Teachers',
                    'Gallery',
                    'Library',
                    'Calendar',
                    'Messages'
                ];
                
                railIcons.forEach(title => {
                    const rail = document.querySelector(`.rail-icon[title="${title}"]`);
                    if (rail) rail.style.display = 'none';
                });
            }
            
            // Hide Admissions if no access (for non-admin roles)
            if (userRoleLevel < 80 || !canAccessModule('admissions')) {
                const admissionsSubmenu = document.querySelector('.submenu-item[onclick*="showAdmissionsSection"]');
                if (admissionsSubmenu) admissionsSubmenu.style.display = 'none';
                
                const admissionsRail = document.querySelector('.rail-icon[title="Admissions"]');
                if (admissionsRail) admissionsRail.style.display = 'none';
            }
            
            // Hide Quick Actions for non-admin roles (only Super Admin and Administrator can see)
            if (userRoleLevel < 80) {
                const quickActionsSection = document.querySelector('.quick-actions');
                if (quickActionsSection) {
                    quickActionsSection.style.display = 'none';
                }
            }
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            
            // Update time
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
            
            // Update date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
            
            // Update greeting
            const hour = now.getHours();
            let greeting = 'Good Evening';
            if (hour < 12) {
                greeting = 'Good Morning';
            } else if (hour < 18) {
                greeting = 'Good Afternoon';
            }
            document.getElementById('greetingText').textContent = greeting;
        }

        async function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }

            try {
                const response = await fetch('../api/auth/logout.php', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    // Clear all session storage including welcome flag
                    sessionStorage.clear();
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Logout Failed',
                        text: 'Please try again.',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: 'Please try again.',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        function loadStats() {
            // Fetch real stats from API
            fetch('../api/dashboard/get_stats.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.data;
                        
                        // Update stat cards
                        document.getElementById('totalStudents').textContent = stats.total_students;
                        document.getElementById('totalTeachers').textContent = stats.total_teachers;
                        
                        // Update attendance
                        const attendanceCard = document.querySelector('.stat-card.green .stat-value');
                        if (attendanceCard) {
                            attendanceCard.textContent = stats.attendance_rate + '%';
                        }
                        
                        // Update revenue
                        const revenueCard = document.querySelector('.stat-card.purple .stat-value');
                        if (revenueCard) {
                            revenueCard.textContent = '$' + stats.revenue.amount.toLocaleString();
                        }
                        
                        // Update stat footers
                        const studentFooter = document.querySelector('.stat-card.blue .stat-change span');
                        if (studentFooter) {
                            studentFooter.textContent = stats.new_students + ' New';
                        }
                        
                        const teacherFooter = document.querySelector('.stat-card.red .stat-change span');
                        if (teacherFooter) {
                            teacherFooter.textContent = stats.inactive_teachers + ' Inactive';
                        }
                        
                        const attendanceFooter = document.querySelector('.stat-card.green .stat-change span');
                        if (attendanceFooter) {
                            attendanceFooter.textContent = stats.absent_count + ' Absent';
                        }
                        
                        const revenueFooter = document.querySelector('.stat-card.purple .stat-change span');
                        if (revenueFooter) {
                            revenueFooter.textContent = stats.revenue.payment_count + ' Collected';
                        }
                        
                        // Update chart with real data
                        updateStudentChart(stats.student_distribution);
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    // Keep default values on error
                });
        }

        // Generate Calendar
        function generateCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = now.getDate();
            
            // Generate calendar dates
            const calendarDates = document.getElementById('calendarDates');
            calendarDates.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-date';
                calendarDates.appendChild(emptyCell);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateCell = document.createElement('div');
                dateCell.className = 'calendar-date';
                dateCell.textContent = day;
                
                if (day === today) {
                    dateCell.classList.add('today');
                }
                
                // Mark some days as having events (example)
                if (day === 15 || day === 20 || day === 25) {
                    dateCell.classList.add('event');
                }
                
                calendarDates.appendChild(dateCell);
            }
        }

        // Toggle submenu
        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const isOpen = submenu.classList.contains('open');
            
            // Close all submenus
            document.querySelectorAll('.submenu').forEach(sub => {
                sub.classList.remove('open');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('expanded');
            });
            
            // Toggle current submenu
            if (!isOpen) {
                submenu.classList.add('open');
                element.classList.add('expanded');
            }
        }

        // Background color rotation
        const backgrounds = ['bg-1', 'bg-2', 'bg-3', 'bg-4', 'bg-5', 'bg-6'];
        let currentBgIndex = 0;

        function changeBackground() {
            const mainContent = document.querySelector('.main-content');
            
            // Remove all background classes
            backgrounds.forEach(bg => mainContent.classList.remove(bg));
            
            // Add new background class
            mainContent.classList.add(backgrounds[currentBgIndex]);
            
            console.log('Background changed to:', backgrounds[currentBgIndex], 'at', new Date().toLocaleTimeString());
            
            // Move to next background
            currentBgIndex = (currentBgIndex + 1) % backgrounds.length;
        }

        // Initialize with first background immediately
        setTimeout(() => {
            changeBackground();
            console.log('Background rotation started - changes every 5 minutes');
        }, 100);

        // Change background every 5 minutes (300000 milliseconds)
        setInterval(changeBackground, 300000);

        // Initialize Student Distribution Chart
        let studentChart = null;
        
        function initializeStudentChart() {
            const ctx = document.getElementById('studentChart');
            if (!ctx) return;

            studentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['P.1', 'P.2', 'P.3', 'P.4', 'P.5', 'P.6', 'P.7'],
                    datasets: [{
                        label: 'Students',
                        data: [0, 0, 0, 0, 0, 0, 0], // Will be updated with real data
                        backgroundColor: [
                            '#0066cc',
                            '#0052a3',
                            '#dc3545',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6',
                            '#06b6d4'
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.8,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: 'Inter'
                                },
                                color: '#1e293b',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            titleFont: {
                                size: 13,
                                family: 'Poppins'
                            },
                            bodyFont: {
                                size: 12,
                                family: 'Inter'
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' students';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateStudentChart(distributionData) {
            if (!studentChart) return;
            
            // Extract labels and data from API response
            const labels = distributionData.map(item => item.class_name);
            const data = distributionData.map(item => parseInt(item.student_count));
            
            // Update chart
            studentChart.data.labels = labels;
            studentChart.data.datasets[0].data = data;
            studentChart.update();
        }
        
        // Load recent activities
        function loadActivities() {
            const timeline = document.querySelector('.activity-timeline');
            if (!timeline) return;
            
            fetch('../api/dashboard/get_activities.php?limit=4')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        timeline.innerHTML = data.data.map(activity => {
                            const iconClass = getActivityIcon(activity.type);
                            const colorClass = getActivityColor(activity.type);
                            
                            return `
                                <div class="activity-item">
                                    <div class="activity-icon ${colorClass}">
                                        <i class="${iconClass}"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">${activity.title}</div>
                                        <div class="activity-desc">${activity.description}</div>
                                        <div class="activity-time">${activity.time_ago}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        timeline.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #999;">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p style="font-size: 15px; margin: 0;">No recent activities</p>
                                <p style="font-size: 13px; margin: 5px 0 0 0;">Activities will appear here as you use the system</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading activities:', error);
                    timeline.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p style="font-size: 15px; margin: 0;">Failed to load activities</p>
                            <p style="font-size: 13px; margin: 5px 0 0 0;">${error.message}</p>
                        </div>
                    `;
                });
        }
        
        function getActivityIcon(type) {
            const icons = {
                'admission': 'fas fa-user-graduate',
                'gallery': 'fas fa-image',
                'teacher': 'fas fa-chalkboard-teacher',
                'library': 'fas fa-book-open',
                'message': 'fas fa-envelope',
                'event': 'fas fa-calendar-check'
            };
            return icons[type] || 'fas fa-info-circle';
        }
        
        function getActivityColor(type) {
            const colors = {
                'admission': 'blue',
                'gallery': 'red',
                'teacher': 'green',
                'library': 'purple',
                'message': 'blue',
                'event': 'green'
            };
            return colors[type] || 'blue';
        }
        
        // Load upcoming events
        function loadEvents() {
            fetch('../api/dashboard/get_events.php?limit=4')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        const eventsList = document.querySelector('.events-list');
                        if (!eventsList) return;
                        
                        eventsList.innerHTML = data.data.map(event => `
                            <div class="event-item">
                                <div class="event-date">
                                    <div class="event-day">${event.day}</div>
                                    <div class="event-month">${event.month}</div>
                                </div>
                                <div class="event-details">
                                    <div class="event-title">${event.title}</div>
                                    <div class="event-time"><i class="fas fa-clock"></i> ${event.time_range}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => console.error('Error loading events:', error));
        }

        // Show Modal Loading with Animation
        function showModalLoading(title, loaderType) {
            const overlay = document.getElementById('modalLoadingOverlay');
            const loaderContainer = document.getElementById('modalLoader');
            const titleElement = document.getElementById('modalLoadingTitle');
            
            titleElement.textContent = title;
            
            // Set loader based on type
            let loaderHTML = '';
            switch(loaderType) {
                case 'dots':
                    loaderHTML = '<div class="loader-dots"><span></span><span></span><span></span></div>';
                    break;
                case 'pulse':
                    loaderHTML = '<div class="loader-pulse"></div>';
                    break;
                case 'dual-ring':
                    loaderHTML = '<div class="loader-dual-ring"></div>';
                    break;
                case 'bars':
                    loaderHTML = '<div class="loader-bars"><span></span><span></span><span></span><span></span><span></span></div>';
                    break;
                case 'orbit':
                    loaderHTML = '<div class="loader-orbit"><span></span><span></span><span></span></div>';
                    break;
                case 'flip':
                    loaderHTML = '<div class="loader-flip"></div>';
                    break;
                default:
                    loaderHTML = '<div class="loader-spinner"></div>';
            }
            
            loaderContainer.innerHTML = loaderHTML;
            overlay.classList.add('active');
        }
        
        // Hide Modal Loading
        function hideModalLoading() {
            const overlay = document.getElementById('modalLoadingOverlay');
            overlay.classList.remove('active');
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // Submit Event Form
        async function submitEvent(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                console.log('Submitting event data:', data);
                const response = await fetch('../api/events/create.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Event created successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    form.reset();
                    closeModal('eventModal');
                    if (typeof loadEvents === 'function') {
                        loadEvents();
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                console.error('Full error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message + '\n\nCheck browser console for details.',
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Event';
            }
        }

        // Submit Testimonial Form
        async function submitTestimonial(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                console.log('Submitting testimonial with file upload');
                const response = await fetch('../api/testimonials/create.php', {
                    method: 'POST',
                    body: formData // Send FormData directly for file upload
                });
                
                console.log('Response status:', response.status);
                
                // Get response text first to see what we're getting
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                // Try to parse as JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error('Invalid response from server: ' + responseText.substring(0, 100));
                }
                
                console.log('Response data:', result);
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Testimonial added successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    form.reset();
                    closeModal('testimonialModal');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                console.error('Full error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Testimonial';
            }
        }

        // Submit Important Day Form
        async function submitImportantDay(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                console.log('Submitting important day data:', data);
                const response = await fetch('../api/calendar/create.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Important Day added successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    form.reset();
                    closeModal('importantDayModal');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                console.error('Full error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message + '\n\nCheck browser console for details.',
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Important Day';
            }
        }

        // Submit Academic Calendar Event Form
        async function submitAcademicCalendar(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                console.log('Submitting academic calendar data:', data);
                const response = await fetch('../api/calendar/create.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Academic Calendar Event added successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    form.reset();
                    closeModal('academicCalendarModal');
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                console.error('Full error:',error);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message + '\n\nCheck browser console for details.',
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Academic Event';
            }
        }

        // Show Messages Section
        function showMessagesSection() {
            showModalLoading('Loading Messages...', 'dots');
            setTimeout(() => {
                hideModalLoading();
                openModal('messagesModal');
                loadMessages();
            }, 800);
        }

        // Load Messages
        async function loadMessages() {
            const container = document.getElementById('messagesList');
            
            // Show loader
            container.innerHTML = `
                <div class="advanced-loader">
                    <div class="loader-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <div class="loader-text">Loading messages...</div>
                </div>
            `;
            
            try {
                const response = await fetch('../api/messages/get_all.php');
                const result = await response.json();
                
                // Add a small delay to show the loader
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (result.success && result.data.length > 0) {
                    container.innerHTML = result.data.map(msg => `
                        <div class="message-card ${msg.status === 'new' ? 'unread' : ''}">
                            <div class="message-header">
                                <div class="message-sender">
                                    <i class="fas fa-user-circle"></i>
                                    <div>
                                        <h4>${msg.name}</h4>
                                        <p>${msg.email}</p>
                                    </div>
                                </div>
                                <div class="message-meta">
                                    <span class="message-date">${new Date(msg.submitted_date).toLocaleDateString()}</span>
                                    <span class="message-status ${msg.status}">${msg.status}</span>
                                </div>
                            </div>
                            <div class="message-subject">
                                <strong>Subject:</strong> ${msg.subject}
                            </div>
                            <div class="message-body">
                                ${msg.message}
                            </div>
                            <div class="message-actions">
                                <button class="btn btn-primary btn-sm" onclick="openReplyModal(${msg.id}, '${msg.name}', '${msg.email}', '${msg.subject.replace(/'/g, "\\'")}', '${msg.message.replace(/'/g, "\\'").replace(/\n/g, ' ')}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                                ${msg.status === 'new' ? `<button class="btn btn-secondary btn-sm" onclick="markAsRead(${msg.id})"><i class="fas fa-check"></i> Mark as Read</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-inbox" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">No Messages Yet</h3>
                            <p style="color: #999;">Contact submissions will appear here</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">Error Loading Messages</h3>
                        <p style="color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Open Reply Modal
        function openReplyModal(id, name, email, subject, message) {
            document.getElementById('replySubmissionId').value = id;
            document.getElementById('originalMessage').innerHTML = `
                <p><strong>From:</strong> ${name} (${email})</p>
                <p><strong>Subject:</strong> ${subject}</p>
                <p><strong>Message:</strong></p>
                <p>${message}</p>
            `;
            openModal('replyModal');
        }

        // Submit Reply
        async function submitReply(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            try {
                const response = await fetch('../api/messages/reply.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Reply sent successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000
                    });
                    form.reset();
                    closeModal('replyModal');
                    loadMessages(); // Reload messages
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
            }
        }

        // Mark as Read
        async function markAsRead(id) {
            try {
                const response = await fetch('../api/messages/mark_read.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadMessages(); // Reload messages
                }
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        // ============================================
        // GALLERY MANAGEMENT FUNCTIONS
        // ============================================

        // Show Gallery Section
        function showGallerySection() {
            showModalLoading('Loading Gallery...', 'pulse');
            setTimeout(() => {
                hideModalLoading();
                openModal('galleryModal');
                loadGalleryImages();
            }, 800);
        }

        // Preview Gallery Images (Multiple)
        function previewGalleryImages(input) {
            const previewContainer = document.getElementById('galleryImagesPreview');
            const previewGrid = document.getElementById('previewGrid');
            const imageCount = document.getElementById('imageCount');
            
            if (input.files && input.files.length > 0) {
                previewGrid.innerHTML = '';
                imageCount.textContent = input.files.length;
                
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}" 
                                 style="width: 100%; height: 120px; object-fit: cover;">
                            <div style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">
                                ${index + 1}
                            </div>
                        `;
                        previewGrid.appendChild(previewItem);
                    };
                    
                    reader.readAsDataURL(file);
                });
                
                previewContainer.style.display = 'block';
            } else {
                previewContainer.style.display = 'none';
            }
        }

        // Submit Gallery Images (Multiple)
        async function submitGalleryImages(e) {
            e.preventDefault();
            const form = e.target;
            const fileInput = form.querySelector('input[type="file"]');
            const files = fileInput.files;
            
            if (files.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Images Selected',
                    text: 'Please select at least one image to upload',
                    confirmButtonColor: '#0066cc'
                });
                return;
            }
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            
            // Show progress
            const originalBtnContent = submitBtn.innerHTML;
            let uploadedCount = 0;
            let failedCount = 0;
            
            submitBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="loader-spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
                    <span>Uploading 0/${files.length}...</span>
                </div>
            `;
            
            // Upload each file
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('image', files[i]);
                
                try {
                    const response = await fetch('../api/gallery/create.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        uploadedCount++;
                    } else {
                        failedCount++;
                        console.error(`Failed to upload ${files[i].name}:`, result.message);
                    }
                } catch (error) {
                    failedCount++;
                    console.error(`Error uploading ${files[i].name}:`, error);
                }
                
                // Update progress
                submitBtn.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="loader-spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
                        <span>Uploading ${i + 1}/${files.length}...</span>
                    </div>
                `;
            }
            
            // Show result
            if (uploadedCount > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Complete!',
                    html: `
                        <p><strong>${uploadedCount}</strong> image(s) uploaded successfully!</p>
                        ${failedCount > 0 ? `<p style="color: #dc3545;"><strong>${failedCount}</strong> image(s) failed to upload.</p>` : ''}
                    `,
                    confirmButtonColor: '#0066cc',
                    timer: 3000
                });
                form.reset();
                document.getElementById('galleryImagesPreview').style.display = 'none';
                loadGalleryImages();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    text: 'All images failed to upload. Please try again.',
                    confirmButtonColor: '#dc3545'
                });
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnContent;
        }

        // Load Gallery Images
        async function loadGalleryImages() {
            const container = document.getElementById('galleryImagesList');
            
            // Show loader with minimum display time
            const loaderStartTime = Date.now();
            container.innerHTML = `
                <div class="advanced-loader">
                    <div class="loader-pulse"></div>
                    <div class="loader-text">Loading gallery images...</div>
                </div>
            `;
            
            try {
                const response = await fetch('../api/gallery/get_all.php');
                const result = await response.json();
                
                // Ensure loader shows for at least 500ms
                const elapsedTime = Date.now() - loaderStartTime;
                const remainingTime = Math.max(0, 500 - elapsedTime);
                
                await new Promise(resolve => setTimeout(resolve, remainingTime));
                
                if (result.success && result.data && result.data.length > 0) {
                    displayGalleryImages(result.data);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-images" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">No Gallery Images Yet</h3>
                            <p style="color: #999;">Upload images using the form above</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading gallery images:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">Error Loading Images</h3>
                        <p style="color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Display Gallery Images
        function displayGalleryImages(images) {
            const container = document.getElementById('galleryImagesList');
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    ${images.map(img => `
                        <div class="gallery-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s;">
                            <div style="position: relative; padding-top: 75%; overflow: hidden;">
                                <img src="../${img.image_url}" alt="${img.title}" 
                                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                                <div style="position: absolute; top: 10px; right: 10px;">
                                    <span style="background: ${getCategoryColor(img.category)}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                        ${img.category}
                                    </span>
                                </div>
                            </div>
                            <div style="padding: 15px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${img.title}</h4>
                                ${img.description ? `<p style="margin: 0 0 12px 0; font-size: 13px; color: #666; line-height: 1.4;">${img.description}</p>` : ''}
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
                                    <span style="font-size: 12px; color: #999;">
                                        <i class="fas fa-calendar"></i> ${img.upload_date}
                                    </span>
                                    <button onclick="deleteGalleryImage(${img.id})" 
                                            style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s;"
                                            onmouseover="this.style.background='#c82333'" 
                                            onmouseout="this.style.background='#dc3545'">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Get Category Color
        function getCategoryColor(category) {
            const colors = {
                'events': '#0066cc',
                'facilities': '#10b981',
                'students': '#f59e0b',
                'activities': '#8b5cf6',
                'achievements': '#dc3545'
            };
            return colors[category] || '#6c757d';
        }


        // Delete Gallery Image
        async function deleteGalleryImage(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This image will be permanently deleted!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('../api/gallery/delete.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Image has been deleted.',
                            confirmButtonColor: '#0066cc',
                            timer: 2000
                        });
                        loadGalleryImages();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Network Error',
                        text: error.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            }
        }

        // ============================================
        // TEACHERS MANAGEMENT FUNCTIONS
        // ============================================

        // Show Teachers Section
        function showTeachersSection() {
            showModalLoading('Loading Teachers...', 'dual-ring');
            setTimeout(() => {
                hideModalLoading();
                openModal('teachersModal');
                loadTeachers();
            }, 800);
        }

        // Show Events Modal
        function showEventsModal() {
            showModalLoading('Loading Events...', 'bars');
            setTimeout(() => {
                hideModalLoading();
                openModal('eventModal');
            }, 800);
        }

        // Show Important Days Modal
        function showImportantDaysModal() {
            showModalLoading('Loading Important Days...', 'orbit');
            setTimeout(() => {
                hideModalLoading();
                openModal('importantDayModal');
            }, 800);
        }

        // Show Academic Calendar Modal
        function showAcademicCalendarModal() {
            showModalLoading('Loading Academic Calendar...', 'flip');
            setTimeout(() => {
                hideModalLoading();
                openModal('academicCalendarModal');
            }, 800);
        }

        // Preview Teacher Photo
        function previewTeacherPhoto(input) {
            const preview = document.getElementById('teacherPhotoPreview');
            const previewImg = document.getElementById('previewTeacherImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Load Teachers
        async function loadTeachers() {
            const container = document.getElementById('teachersList');
            
            // Show loader with minimum display time
            const loaderStartTime = Date.now();
            container.innerHTML = `
                <div class="advanced-loader">
                    <div class="loader-dual-ring"></div>
                    <div class="loader-text">Loading teachers...</div>
                </div>
            `;
            
            try {
                const response = await fetch('../api/teachers/get_all.php');
                const result = await response.json();
                
                // Ensure loader shows for at least 500ms
                const elapsedTime = Date.now() - loaderStartTime;
                const remainingTime = Math.max(0, 500 - elapsedTime);
                await new Promise(resolve => setTimeout(resolve, remainingTime));
                
                if (result.success && result.data && result.data.length > 0) {
                    displayTeachers(result.data);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-chalkboard-teacher" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">No Teachers Yet</h3>
                            <p style="color: #999;">Add teachers using the form above</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">Error Loading Teachers</h3>
                        <p style="color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Display Teachers
        function displayTeachers(teachers) {
            const container = document.getElementById('teachersList');
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    ${teachers.map(teacher => `
                        <div class="teacher-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s;">
                            <div style="position: relative; padding-top: 100%; overflow: hidden; background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);">
                                ${teacher.photo_url ? `
                                    <img src="../${teacher.photo_url}" alt="${teacher.full_name}" 
                                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                                ` : `
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                                        <i class="fas fa-user" style="font-size: 4rem; opacity: 0.5;"></i>
                                    </div>
                                `}
                                <div style="position: absolute; top: 10px; right: 10px;">
                                    <span style="background: ${getDepartmentColor(teacher.department)}; color: white; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                        ${teacher.department}
                                    </span>
                                </div>
                            </div>
                            <div style="padding: 20px;">
                                <h4 style="margin: 0 0 5px 0; font-size: 17px; color: #333; font-weight: 600;">${teacher.full_name}</h4>
                                ${teacher.position ? `<p style="margin: 0 0 10px 0; font-size: 13px; color: #0066cc; font-weight: 500;">${teacher.position}</p>` : ''}
                                ${teacher.qualification ? `<p style="margin: 0 0 8px 0; font-size: 12px; color: #666;"><i class="fas fa-graduation-cap"></i> ${teacher.qualification}</p>` : ''}
                                ${teacher.experience_years ? `<p style="margin: 0 0 8px 0; font-size: 12px; color: #666;"><i class="fas fa-calendar-alt"></i> ${teacher.experience_years} years experience</p>` : ''}
                                ${teacher.email ? `<p style="margin: 0 0 8px 0; font-size: 12px; color: #666;"><i class="fas fa-envelope"></i> ${teacher.email}</p>` : ''}
                                ${teacher.phone ? `<p style="margin: 0 0 8px 0; font-size: 12px; color: #666;"><i class="fas fa-phone"></i> ${teacher.phone}</p>` : ''}
                                ${teacher.bio ? `<p style="margin: 12px 0; font-size: 13px; color: #666; line-height: 1.5; border-top: 1px solid #eee; padding-top: 12px;">${teacher.bio}</p>` : ''}
                                ${teacher.specialization ? `<p style="margin: 8px 0 12px 0; font-size: 12px; color: #0066cc;"><i class="fas fa-book"></i> ${teacher.specialization}</p>` : ''}
                                <div style="display: flex; justify-content: flex-end; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                    <button onclick="deleteTeacher(${teacher.id})" 
                                            style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s;"
                                            onmouseover="this.style.background='#c82333'" 
                                            onmouseout="this.style.background='#dc3545'">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Get Department Color
        function getDepartmentColor(department) {
            const colors = {
                'administration': '#dc3545',
                'english': '#0066cc',
                'mathematics': '#10b981',
                'science': '#8b5cf6',
                'social': '#f59e0b'
            };
            return colors[department] || '#6c757d';
        }

        // Submit Teacher
        async function submitTeacher(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="loader-spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
                    <span>Adding...</span>
                </div>
            `;
            
            const uploadStartTime = Date.now();
            
            try {
                const response = await fetch('../api/teachers/create.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Ensure loader shows for at least 500ms
                const elapsedTime = Date.now() - uploadStartTime;
                const remainingTime = Math.max(0, 500 - elapsedTime);
                await new Promise(resolve => setTimeout(resolve, remainingTime));
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Teacher added successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000
                    });
                    form.reset();
                    document.getElementById('teacherPhotoPreview').style.display = 'none';
                    loadTeachers();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
            }
        }

        // Delete Teacher
        async function deleteTeacher(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This teacher will be permanently deleted!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('../api/teachers/delete.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Teacher has been deleted.',
                            confirmButtonColor: '#0066cc',
                            timer: 2000
                        });
                        loadTeachers();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Network Error',
                        text: error.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            }
        }

        // ============================================
        // LIBRARY MANAGEMENT FUNCTIONS
        // ============================================

        // Show Library Section
        function showLibrarySection() {
            showModalLoading('Loading Library...', 'bars');
            setTimeout(() => {
                hideModalLoading();
                openModal('libraryModal');
                loadLibraryResources();
            }, 800);
        }

        // Load Library Resources
        async function loadLibraryResources() {
            const container = document.getElementById('libraryResourcesList');
            
            // Show loader
            const loaderStartTime = Date.now();
            container.innerHTML = `
                <div class="advanced-loader">
                    <div class="loader-bars">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <div class="loader-text">Loading resources...</div>
                </div>
            `;
            
            try {
                const response = await fetch('../api/library/get_all.php');
                const result = await response.json();
                
                // Ensure loader shows for at least 500ms
                const elapsedTime = Date.now() - loaderStartTime;
                const remainingTime = Math.max(0, 500 - elapsedTime);
                await new Promise(resolve => setTimeout(resolve, remainingTime));
                
                if (result.success && result.data && result.data.length > 0) {
                    displayLibraryResources(result.data);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-book-open" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">No Resources Yet</h3>
                            <p style="color: #999;">Upload resources using the form above</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading resources:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">Error Loading Resources</h3>
                        <p style="color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Display Library Resources
        function displayLibraryResources(resources) {
            const container = document.getElementById('libraryResourcesList');
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                    ${resources.map(resource => `
                        <div class="resource-card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s;">
                            <div style="background: linear-gradient(135deg, ${getCategoryColorLib(resource.category)} 0%, ${getCategoryColorLib(resource.category)}dd 100%); padding: 20px; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <span style="background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                            ${resource.category.replace('_', ' ')}
                                        </span>
                                    </div>
                                    <i class="fas fa-${getFileIcon(resource.file_type)}" style="font-size: 2rem; opacity: 0.3;"></i>
                                </div>
                                <h4 style="margin: 10px 0 5px 0; font-size: 16px; font-weight: 600;">${resource.title}</h4>
                                <p style="font-size: 12px; opacity: 0.9; margin: 0;">${resource.class_level.toUpperCase()} ${resource.subject ? ' ' + resource.subject : ''}</p>
                            </div>
                            <div style="padding: 20px;">
                                ${resource.description ? `<p style="margin: 0 0 15px 0; font-size: 13px; color: #666; line-height: 1.5;">${resource.description}</p>` : ''}
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="font-size: 12px; color: #666;">
                                        <i class="fas fa-file"></i> ${resource.file_type.toUpperCase()}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        <i class="fas fa-download"></i> ${resource.download_count || 0} downloads
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        <i class="fas fa-hdd"></i> ${formatFileSize(resource.file_size)}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        <i class="fas fa-calendar"></i> ${resource.upload_date}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="deleteLibraryResource(${resource.id})" 
                                            style="flex: 1; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s;"
                                            onmouseover="this.style.background='#c82333'" 
                                            onmouseout="this.style.background='#dc3545'">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Get Category Color for Library
        function getCategoryColorLib(category) {
            const colors = {
                'assignment': '#0066cc',
                'reading': '#10b981',
                'past_exam': '#dc3545',
                'revision': '#f59e0b',
                'multimedia': '#8b5cf6',
                'study_guide': '#06b6d4'
            };
            return colors[category] || '#6c757d';
        }

        // Get File Icon
        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'file-pdf',
                'doc': 'file-word',
                'docx': 'file-word',
                'xls': 'file-excel',
                'xlsx': 'file-excel',
                'ppt': 'file-powerpoint',
                'pptx': 'file-powerpoint',
                'jpg': 'file-image',
                'jpeg': 'file-image',
                'png': 'file-image',
                'mp4': 'file-video'
            };
            return icons[fileType.toLowerCase()] || 'file';
        }

        // Format File Size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Preview Library Files
        function previewLibraryFiles(input) {
            const files = input.files;
            const previewContainer = document.getElementById('libraryFilesPreview');
            const previewGrid = document.getElementById('filesPreviewGrid');
            const fileCount = document.getElementById('fileCount');
            
            if (files.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            
            fileCount.textContent = files.length;
            previewContainer.style.display = 'block';
            
            let html = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop().toLowerCase();
                const fileIcon = getFileIcon(fileExt);
                
                html += `
                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${fileIcon}" style="font-size: 24px; color: #0066cc;"></i>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.name}">
                                ${file.name}
                            </div>
                            <div style="font-size: 11px; color: #999;">
                                ${formatFileSize(file.size)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            previewGrid.innerHTML = html;
        }

        // Submit Library Resources (Multiple)
        async function submitLibraryResources(e) {
            e.preventDefault();
            const form = e.target;
            const fileInput = form.querySelector('input[type="file"]');
            const files = fileInput.files;
            
            if (files.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Files Selected',
                    text: 'Please select at least one file to upload',
                    confirmButtonColor: '#0066cc'
                });
                return;
            }
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            
            // Get form values
            const title = form.querySelector('[name="title"]').value;
            const description = form.querySelector('[name="description"]').value;
            const category = form.querySelector('[name="category"]').value;
            const classLevel = form.querySelector('[name="class_level"]').value;
            const subject = form.querySelector('[name="subject"]').value;
            const uploadDate = form.querySelector('[name="upload_date"]').value;
            
            // Show progress
            const originalBtnContent = submitBtn.innerHTML;
            let uploadedCount = 0;
            let failedCount = 0;
            
            submitBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="loader-spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
                    <span>Uploading 0/${files.length}...</span>
                </div>
            `;
            
            // Upload each file
            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                
                // Use title only for single file, otherwise auto-generate from filename
                if (files.length === 1 && title) {
                    formData.append('title', title);
                }
                
                formData.append('description', description);
                formData.append('category', category);
                formData.append('class_level', classLevel);
                formData.append('subject', subject);
                formData.append('upload_date', uploadDate);
                
                try {
                    const response = await fetch('../api/library/create.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        uploadedCount++;
                    } else {
                        failedCount++;
                        console.error(`Failed to upload ${files[i].name}:`, result.message);
                    }
                } catch (error) {
                    failedCount++;
                    console.error(`Error uploading ${files[i].name}:`, error);
                }
                
                // Update progress
                submitBtn.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="loader-spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
                        <span>Uploading ${i + 1}/${files.length}...</span>
                    </div>
                `;
            }
            
            // Show result
            if (uploadedCount > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Complete!',
                    html: `
                        <p><strong>${uploadedCount}</strong> file(s) uploaded successfully!</p>
                        ${failedCount > 0 ? `<p style="color: #dc3545;"><strong>${failedCount}</strong> file(s) failed to upload.</p>` : ''}
                    `,
                    confirmButtonColor: '#0066cc',
                    timer: 3000
                });
                form.reset();
                document.getElementById('libraryFilesPreview').style.display = 'none';
                loadLibraryResources();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    text: 'All files failed to upload. Please try again.',
                    confirmButtonColor: '#dc3545'
                });
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnContent;
        }

        // Submit Library Resource
        async function submitLibraryResource(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const submitBtn = form.querySelector('[type="submit"]');
            submitBtn.disabled = true;
            
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div class="loader-spinner" style="width: 20px; height: 20px; border-width: 3px;"></div>
                    <span>Uploading...</span>
                </div>
            `;
            
            const uploadStartTime = Date.now();
            
            try {
                const response = await fetch('../api/library/create.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Ensure loader shows for at least 500ms
                const elapsedTime = Date.now() - uploadStartTime;
                const remainingTime = Math.max(0, 500 - elapsedTime);
                await new Promise(resolve => setTimeout(resolve, remainingTime));
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Resource uploaded successfully!',
                        confirmButtonColor: '#0066cc',
                        timer: 2000
                    });
                    form.reset();
                    loadLibraryResources();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
            }
        }

        // Delete Library Resource
        async function deleteLibraryResource(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This resource will be permanently deleted!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('../api/library/delete.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Resource has been deleted.',
                            confirmButtonColor: '#0066cc',
                            timer: 2000
                        });
                        loadLibraryResources();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Network Error',
                        text: error.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            }
        }

        // ============================================
        // ADMISSIONS MANAGEMENT FUNCTIONS
        // ============================================

        function showAdmissionsSection() {
            openModal('admissionsModal');
            loadAdmissions();
        }

        async function loadAdmissions() {
            const container = document.getElementById('admissionsList');
            container.innerHTML = '<div style="text-align:center;padding:40px;"><div class="loader-spinner"></div><p>Loading...</p></div>';
            
            try {
                const response = await fetch('../api/admissions/list.php');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    // Update total count
                    const totalElement = document.getElementById('totalApplications');
                    if (totalElement) {
                        totalElement.textContent = result.data.length;
                    }
                    
                    let html = '';
                    result.data.forEach(app => {
                        // Status badge styling
                        let statusBadge = '';
                        let borderColor = '#0066cc';
                        switch(app.status) {
                            case 'accepted':
                                statusBadge = '<span style="background:#d1fae5;color:#065f46;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;"><i class="fas fa-check-circle"></i> ACCEPTED</span>';
                                borderColor = '#10b981';
                                break;
                            case 'rejected':
                                statusBadge = '<span style="background:#fee2e2;color:#991b1b;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;"><i class="fas fa-times-circle"></i> REJECTED</span>';
                                borderColor = '#dc3545';
                                break;
                            case 'waitlist':
                                statusBadge = '<span style="background:#fef3c7;color:#92400e;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;"><i class="fas fa-clock"></i> WAITLIST</span>';
                                borderColor = '#f59e0b';
                                break;
                            default:
                                statusBadge = '<span style="background:#e0f2fe;color:#075985;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;"><i class="fas fa-hourglass-half"></i> PENDING</span>';
                                borderColor = '#0066cc';
                        }
                        
                        html += `
                            <div style="background:white;padding:24px;margin-bottom:16px;border-radius:12px;border-left:5px solid ${borderColor};box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
                                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                                    <div>
                                        <h4 style="margin:0 0 8px 0;color:#1e293b;font-size:18px;font-weight:600;">
                                            <i class="fas fa-user-graduate" style="color:${borderColor};margin-right:8px;"></i>
                                            ${app.student_first_name} ${app.student_last_name}
                                        </h4>
                                        <p style="margin:0;color:#64748b;font-size:13px;font-weight:500;">
                                            <i class="fas fa-id-card" style="margin-right:6px;"></i>${app.application_id}
                                        </p>
                                    </div>
                                    ${statusBadge}
                                </div>
                                
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px;padding:16px;background:#f8fafc;border-radius:8px;">
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:500;">CLASS</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;"><i class="fas fa-graduation-cap" style="color:#0066cc;margin-right:6px;"></i>${app.class_to_join}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:500;">TYPE</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;"><i class="fas fa-home" style="color:#0066cc;margin-right:6px;"></i>${app.admission_type}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:500;">PARENT</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;"><i class="fas fa-user" style="color:#0066cc;margin-right:6px;"></i>${app.parent_first_name} ${app.parent_last_name}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:500;">CONTACT</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;"><i class="fas fa-phone" style="color:#0066cc;margin-right:6px;"></i>${app.parent_phone}</p>
                                    </div>
                                </div>
                                
                                <div style="display:flex;flex-wrap:wrap;gap:8px;">
                                    <button onclick="viewAdmission(${app.id})" style="background:#0066cc;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="editAdmission(${app.id})" style="background:#475569;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="updateStatus(${app.id},'accepted')" style="background:#10b981;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                    <button onclick="updateStatus(${app.id},'rejected')" style="background:#dc3545;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#bb2d3b'" onmouseout="this.style.background='#dc3545'">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                    <button onclick="updateStatus(${app.id},'waitlist')" style="background:#f59e0b;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                                        <i class="fas fa-clock"></i> Waitlist
                                    </button>
                                    <button onclick="updateStatus(${app.id},'pending')" style="background:#6c757d;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                                        <i class="fas fa-undo"></i> Undo
                                    </button>
                                    <button onclick="deleteAdmission(${app.id})" style="background:#dc3545;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#bb2d3b'" onmouseout="this.style.background='#dc3545'">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="text-align:center;padding:60px 20px;background:white;border-radius:12px;border:2px dashed #cbd5e1;">
                            <i class="fas fa-inbox" style="font-size:48px;color:#cbd5e1;margin-bottom:16px;"></i>
                            <p style="color:#64748b;font-size:16px;margin:0;">No applications yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;background:#fee2e2;border-radius:12px;border-left:4px solid #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size:32px;color:#dc3545;margin-bottom:12px;"></i>
                        <p style="color:#991b1b;font-weight:600;margin:0;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function viewAdmission(id) {
            try {
                const response = await fetch(`../api/admissions/get.php?id=${id}`);
                const result = await response.json();
                if (result.success) {
                    const app = result.data;
                    
                    // Status badge
                    let statusBadge = '';
                    switch(app.status) {
                        case 'accepted':
                            statusBadge = '<span style="background:#d1fae5;color:#065f46;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;"><i class="fas fa-check-circle"></i> ACCEPTED</span>';
                            break;
                        case 'rejected':
                            statusBadge = '<span style="background:#fee2e2;color:#991b1b;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;"><i class="fas fa-times-circle"></i> REJECTED</span>';
                            break;
                        case 'waitlist':
                            statusBadge = '<span style="background:#fef3c7;color:#92400e;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;"><i class="fas fa-clock"></i> WAITLIST</span>';
                            break;
                        default:
                            statusBadge = '<span style="background:#e0f2fe;color:#075985;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;"><i class="fas fa-hourglass-half"></i> PENDING</span>';
                    }
                    
                    const content = `
                        <div style="padding:24px;">
                            <!-- Header -->
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid #e2e8f0;">
                                <div>
                                    <h3 style="margin:0 0 8px 0;color:#1e293b;font-size:24px;font-weight:700;">
                                        ${app.student_first_name} ${app.student_last_name}
                                    </h3>
                                    <p style="margin:0;color:#64748b;font-size:14px;"><i class="fas fa-id-card"></i> ${app.application_id}</p>
                                </div>
                                ${statusBadge}
                            </div>
                            
                            <!-- Student Information -->
                            <div style="margin-bottom:30px;">
                                <h4 style="color:#0066cc;margin:0 0 16px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-user-graduate"></i> Student Information
                                </h4>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;padding:20px;background:#f8fafc;border-radius:12px;">
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Date of Birth</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.date_of_birth}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Gender</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.gender}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Nationality</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.nationality}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Religion</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.religion || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Class to Join</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.class_to_join}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Admission Type</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.admission_type}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Parent Information -->
                            <div style="margin-bottom:30px;">
                                <h4 style="color:#0066cc;margin:0 0 16px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-users"></i> Parent/Guardian Information
                                </h4>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;padding:20px;background:#f8fafc;border-radius:12px;">
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Full Name</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.parent_first_name} ${app.parent_last_name}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Relationship</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.parent_relationship}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Phone</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;"><i class="fas fa-phone" style="color:#0066cc;margin-right:6px;"></i>${app.parent_phone}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Email</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;"><i class="fas fa-envelope" style="color:#0066cc;margin-right:6px;"></i>${app.parent_email}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Occupation</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.parent_occupation || 'N/A'}</p>
                                    </div>
                                    <div style="grid-column:1/-1;">
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Address</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;"><i class="fas fa-map-marker-alt" style="color:#0066cc;margin-right:6px;"></i>${app.parent_address || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Emergency Contact -->
                            <div style="margin-bottom:20px;">
                                <h4 style="color:#0066cc;margin:0 0 16px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-phone-alt"></i> Emergency Contact
                                </h4>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;padding:20px;background:#f8fafc;border-radius:12px;">
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Name</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.emergency_contact_name}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Relationship</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;">${app.emergency_contact_relationship}</p>
                                    </div>
                                    <div>
                                        <p style="margin:0 0 4px 0;color:#64748b;font-size:12px;font-weight:600;text-transform:uppercase;">Phone</p>
                                        <p style="margin:0;color:#1e293b;font-weight:600;font-size:15px;"><i class="fas fa-phone" style="color:#0066cc;margin-right:6px;"></i>${app.emergency_contact_phone}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Uploaded Documents -->
                            <div style="margin-bottom:30px;">
                                <h4 style="color:#0066cc;margin:0 0 16px 0;font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-file-alt"></i> Uploaded Documents
                                </h4>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                                    ${app.birth_certificate_url ? `
                                    <a href="../${app.birth_certificate_url}" target="_blank" style="padding:16px;background:white;border:2px solid #e2e8f0;border-radius:12px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='#0066cc';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                        <i class="fas fa-file-pdf" style="font-size:24px;color:#dc3545;"></i>
                                        <div>
                                            <p style="margin:0;color:#1e293b;font-weight:600;font-size:13px;">Birth Certificate</p>
                                            <p style="margin:4px 0 0 0;color:#64748b;font-size:11px;">Click to view</p>
                                        </div>
                                    </a>
                                    ` : '<div style="padding:16px;background:#fee2e2;border:2px dashed #dc3545;border-radius:12px;text-align:center;"><i class="fas fa-times-circle" style="color:#dc3545;"></i><p style="margin:4px 0 0 0;color:#991b1b;font-size:12px;font-weight:600;">Birth Certificate - Not uploaded</p></div>'}
                                    
                                    ${app.passport_photo_url ? `
                                    <a href="../${app.passport_photo_url}" target="_blank" style="padding:16px;background:white;border:2px solid #e2e8f0;border-radius:12px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='#0066cc';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                        <i class="fas fa-image" style="font-size:24px;color:#10b981;"></i>
                                        <div>
                                            <p style="margin:0;color:#1e293b;font-weight:600;font-size:13px;">Passport Photo</p>
                                            <p style="margin:4px 0 0 0;color:#64748b;font-size:11px;">Click to view</p>
                                        </div>
                                    </a>
                                    ` : '<div style="padding:16px;background:#fee2e2;border:2px dashed #dc3545;border-radius:12px;text-align:center;"><i class="fas fa-times-circle" style="color:#dc3545;"></i><p style="margin:4px 0 0 0;color:#991b1b;font-size:12px;font-weight:600;">Passport Photo - Not uploaded</p></div>'}
                                    
                                    ${app.previous_school_report_url ? `
                                    <a href="../${app.previous_school_report_url}" target="_blank" style="padding:16px;background:white;border:2px solid #e2e8f0;border-radius:12px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='#0066cc';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                        <i class="fas fa-file-alt" style="font-size:24px;color:#f59e0b;"></i>
                                        <div>
                                            <p style="margin:0;color:#1e293b;font-weight:600;font-size:13px;">Previous Report</p>
                                            <p style="margin:4px 0 0 0;color:#64748b;font-size:11px;">Click to view</p>
                                        </div>
                                    </a>
                                    ` : '<div style="padding:16px;background:#f1f5f9;border:2px dashed #cbd5e1;border-radius:12px;text-align:center;"><i class="fas fa-minus-circle" style="color:#94a3b8;"></i><p style="margin:4px 0 0 0;color:#64748b;font-size:12px;font-weight:600;">Previous Report - Optional</p></div>'}
                                    
                                    ${app.immunization_record_url ? `
                                    <a href="../${app.immunization_record_url}" target="_blank" style="padding:16px;background:white;border:2px solid #e2e8f0;border-radius:12px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='#0066cc';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                        <i class="fas fa-syringe" style="font-size:24px;color:#8b5cf6;"></i>
                                        <div>
                                            <p style="margin:0;color:#1e293b;font-weight:600;font-size:13px;">Immunization Record</p>
                                            <p style="margin:4px 0 0 0;color:#64748b;font-size:11px;">Click to view</p>
                                        </div>
                                    </a>
                                    ` : '<div style="padding:16px;background:#f1f5f9;border:2px dashed #cbd5e1;border-radius:12px;text-align:center;"><i class="fas fa-minus-circle" style="color:#94a3b8;"></i><p style="margin:4px 0 0 0;color:#64748b;font-size:12px;font-weight:600;">Immunization - Optional</p></div>'}
                                    
                                    ${app.parent_id_url ? `
                                    <a href="../${app.parent_id_url}" target="_blank" style="padding:16px;background:white;border:2px solid #e2e8f0;border-radius:12px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='#0066cc';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                        <i class="fas fa-id-card" style="font-size:24px;color:#06b6d4;"></i>
                                        <div>
                                            <p style="margin:0;color:#1e293b;font-weight:600;font-size:13px;">Parent ID</p>
                                            <p style="margin:4px 0 0 0;color:#64748b;font-size:11px;">Click to view</p>
                                        </div>
                                    </a>
                                    ` : '<div style="padding:16px;background:#f1f5f9;border:2px dashed #cbd5e1;border-radius:12px;text-align:center;"><i class="fas fa-minus-circle" style="color:#94a3b8;"></i><p style="margin:4px 0 0 0;color:#64748b;font-size:12px;font-weight:600;">Parent ID - Optional</p></div>'}
                                    
                                    ${app.transfer_letter_url ? `
                                    <a href="../${app.transfer_letter_url}" target="_blank" style="padding:16px;background:white;border:2px solid #e2e8f0;border-radius:12px;text-decoration:none;display:flex;align-items:center;gap:12px;transition:all 0.2s;" onmouseover="this.style.borderColor='#0066cc';this.style.boxShadow='0 4px 12px rgba(0,102,204,0.15)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                                        <i class="fas fa-exchange-alt" style="font-size:24px;color:#ec4899;"></i>
                                        <div>
                                            <p style="margin:0;color:#1e293b;font-weight:600;font-size:13px;">Transfer Letter</p>
                                            <p style="margin:4px 0 0 0;color:#64748b;font-size:11px;">Click to view</p>
                                        </div>
                                    </a>
                                    ` : '<div style="padding:16px;background:#f1f5f9;border:2px dashed #cbd5e1;border-radius:12px;text-align:center;"><i class="fas fa-minus-circle" style="color:#94a3b8;"></i><p style="margin:4px 0 0 0;color:#64748b;font-size:12px;font-weight:600;">Transfer Letter - Optional</p></div>'}
                                </div>
                            </div>
                            
                            ${app.review_notes ? `
                            <!-- Review Notes -->
                            <div style="margin-top:30px;padding:20px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:8px;">
                                <h4 style="color:#92400e;margin:0 0 12px 0;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;">
                                    <i class="fas fa-sticky-note"></i> Review Notes
                                </h4>
                                <p style="margin:0;color:#78350f;font-size:14px;line-height:1.6;">${app.review_notes}</p>
                                ${app.review_date ? `<p style="margin:8px 0 0 0;color:#92400e;font-size:12px;"><i class="fas fa-clock"></i> Reviewed on: ${new Date(app.review_date).toLocaleString()}</p>` : ''}
                            </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('viewAdmissionContent').innerHTML = content;
                    openModal('viewAdmissionModal');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function editAdmission(id) {
            try {
                const response = await fetch(`../api/admissions/get.php?id=${id}`);
                const result = await response.json();
                if (result.success) {
                    const app = result.data;
                    const form = document.getElementById('editAdmissionForm');
                    document.getElementById('editAdmissionId').value = app.id;
                    form.querySelector('[name="student_first_name"]').value = app.student_first_name;
                    form.querySelector('[name="student_last_name"]').value = app.student_last_name;
                    form.querySelector('[name="date_of_birth"]').value = app.date_of_birth;
                    form.querySelector('[name="gender"]').value = app.gender;
                    form.querySelector('[name="nationality"]').value = app.nationality;
                    form.querySelector('[name="religion"]').value = app.religion || '';
                    form.querySelector('[name="class_to_join"]').value = app.class_to_join;
                    form.querySelector('[name="admission_type"]').value = app.admission_type;
                    form.querySelector('[name="parent_first_name"]').value = app.parent_first_name;
                    form.querySelector('[name="parent_last_name"]').value = app.parent_last_name;
                    form.querySelector('[name="parent_relationship"]').value = app.parent_relationship;
                    form.querySelector('[name="parent_phone"]').value = app.parent_phone;
                    form.querySelector('[name="parent_email"]').value = app.parent_email || '';
                    form.querySelector('[name="parent_occupation"]').value = app.parent_occupation || '';
                    form.querySelector('[name="parent_address"]').value = app.parent_address || '';
                    form.querySelector('[name="emergency_contact_name"]').value = app.emergency_contact_name;
                    form.querySelector('[name="emergency_contact_relationship"]').value = app.emergency_contact_relationship;
                    form.querySelector('[name="emergency_contact_phone"]').value = app.emergency_contact_phone;
                    
                    // Show current documents
                    document.getElementById('currentBirthCert').innerHTML = app.birth_certificate_url ? '<i class="fas fa-check-circle" style="color:#10b981;"></i> Current file uploaded' : '<i class="fas fa-times-circle" style="color:#dc3545;"></i> No file uploaded';
                    document.getElementById('currentPassportPhoto').innerHTML = app.passport_photo_url ? '<i class="fas fa-check-circle" style="color:#10b981;"></i> Current file uploaded' : '<i class="fas fa-times-circle" style="color:#dc3545;"></i> No file uploaded';
                    document.getElementById('currentPreviousReport').innerHTML = app.previous_school_report_url ? '<i class="fas fa-check-circle" style="color:#10b981;"></i> Current file uploaded' : '<i class="fas fa-info-circle" style="color:#94a3b8;"></i> Optional';
                    document.getElementById('currentImmunization').innerHTML = app.immunization_record_url ? '<i class="fas fa-check-circle" style="color:#10b981;"></i> Current file uploaded' : '<i class="fas fa-info-circle" style="color:#94a3b8;"></i> Optional';
                    document.getElementById('currentParentId').innerHTML = app.parent_id_url ? '<i class="fas fa-check-circle" style="color:#10b981;"></i> Current file uploaded' : '<i class="fas fa-info-circle" style="color:#94a3b8;"></i> Optional';
                    document.getElementById('currentTransferLetter').innerHTML = app.transfer_letter_url ? '<i class="fas fa-check-circle" style="color:#10b981;"></i> Current file uploaded' : '<i class="fas fa-info-circle" style="color:#94a3b8;"></i> Optional';
                    
                    openModal('editAdmissionModal');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function submitEditAdmission(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('../api/admissions/update.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    closeModal('editAdmissionModal');
                    loadAdmissions();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function updateStatus(id, status) {
            const result = await Swal.fire({
                title: 'Confirm Status Change',
                text: `Change status to ${status}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#0066cc',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, change it!',
                cancelButtonText: 'Cancel'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('../api/admissions/update-status.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id, status, notes: ''})
                    });
                    
                    // Get response text first to see what we're getting
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);
                    
                    // Try to parse as JSON
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.error('Response was:', responseText);
                        throw new Error('Server returned invalid response. Status was updated but there was a display error.');
                    }
                    
                    if (result.success) {
                        let emailIcon = '';
                        let emailMessage = result.email_status || 'No email status';
                        
                        // Check if email was sent successfully
                        if (emailMessage.includes('sent successfully')) {
                            emailIcon = '';
                        } else if (emailMessage.includes('No parent email')) {
                            emailIcon = '';
                        } else if (emailMessage.includes('failed') || emailMessage.includes('error')) {
                            emailIcon = '';
                        }
                        
                        Swal.fire({
                            icon: 'success', 
                            title: 'Status Updated!', 
                            html: `
                                <div style="text-align: left; padding: 10px;">
                                    <p style="margin: 10px 0;"><strong> Status:</strong> Updated successfully</p>
                                    <p style="margin: 10px 0;"><strong>${emailIcon} Email:</strong> ${emailMessage}</p>
                                    ${emailMessage.includes('sent successfully') ? 
                                        '<p style="margin: 15px 0; padding: 10px; background: #e8f4f8; border-radius: 8px; font-size: 13px; color: #0066cc;"><strong>Note:</strong> If testing with cultoonmovic4@gmail.com, the email won\'t be delivered because Gmail blocks emails sent to the same address. Test with a different email address.</p>' 
                                        : ''}
                                </div>
                            `,
                            confirmButtonColor: '#0066cc',
                            confirmButtonText: 'OK'
                        });
                        loadAdmissions();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Status Updated',
                        text: 'The status was updated successfully. Please refresh to see changes.',
                        confirmButtonColor: '#0066cc'
                    }).then(() => {
                        loadAdmissions();
                    });
                }
            }
        }
        async function deleteAdmission(id) {
            if (confirm('Delete this application permanently?')) {
                try {
                    const response = await fetch('../api/admissions/delete.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id})
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire({icon: 'success', title: 'Deleted!', text: result.message, timer: 2000});
                        loadAdmissions();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }
        
        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardSettings(); // Load saved UI settings
            loadActivities();
            loadNotifications();
            loadUserProfile();
            loadUpcomingEvents();
            // Refresh notifications every 30 seconds
            setInterval(loadNotifications, 30000);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const userProfile = document.querySelector('.user-profile');
                const dropdown = document.getElementById('userDropdown');
                if (dropdown && dropdown.classList.contains('show')) {
                    if (!userProfile.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('show');
                    }
                }
            });
        });
        
        // Load user profile
        function loadUserProfile() {
            fetch('../api/profile/get.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const user = data.data;
                        const initial = user.full_name ? user.full_name.charAt(0).toUpperCase() : 'A';
                        
                        // Update navbar
                        document.getElementById('userName').textContent = user.full_name || 'Administrator';
                        document.getElementById('userRole').textContent = 'SUPER ADMINISTRATOR';
                        document.getElementById('userAvatar').textContent = initial;
                        
                        // Update dropdown
                        document.getElementById('userNameDropdown').textContent = user.full_name || 'Administrator';
                        document.getElementById('userEmailDropdown').textContent = user.email || '';
                        document.getElementById('userAvatarLarge').textContent = initial;
                        
                        // Update avatar with image if exists
                        if (user.profile_image) {
                            // Path in DB: backend/uploads/profiles/profile_1_xxx.jpg
                            // Current location: backend/admin/dashboard.html
                            // Need to go: ../uploads/profiles/profile_1_xxx.jpg
                            let imagePath = user.profile_image.replace('backend/', '../');
                            
                            console.log('Loading profile image from:', imagePath);
                            
                            document.getElementById('userAvatar').innerHTML = `<img src="${imagePath}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;" onerror="console.error('Failed to load image:', this.src)">`;
                            document.getElementById('userAvatarLarge').innerHTML = `<img src="${imagePath}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="console.error('Failed to load image:', this.src)">`;
                        }
                    } else {
                        console.error('Profile load failed:', data.message);
                        // Set default values
                        document.getElementById('userName').textContent = 'Administrator';
                        document.getElementById('userRole').textContent = 'SUPER ADMINISTRATOR';
                        document.getElementById('userAvatar').textContent = 'A';
                        document.getElementById('userNameDropdown').textContent = 'Administrator';
                        document.getElementById('userEmailDropdown').textContent = 'admin@stlawrence.edu';
                        document.getElementById('userAvatarLarge').textContent = 'A';
                    }
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                    // Set default values on error
                    document.getElementById('userName').textContent = 'Administrator';
                    document.getElementById('userRole').textContent = 'SUPER ADMINISTRATOR';
                    document.getElementById('userAvatar').textContent = 'A';
                    document.getElementById('userNameDropdown').textContent = 'Administrator';
                    document.getElementById('userEmailDropdown').textContent = 'admin@stlawrence.edu';
                    document.getElementById('userAvatarLarge').textContent = 'A';
                });
        }
        
        // Toggle user dropdown
        function toggleUserDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // Profile Settings
        async function openProfileSettings() {
            // Load current profile data
            const response = await fetch('../api/profile/get.php');
            const result = await response.json();
            
            if (!result.success) {
                Swal.fire('Error', 'Failed to load profile', 'error');
                return;
            }
            
            const user = result.data;
            const initial = user.full_name ? user.full_name.charAt(0).toUpperCase() : 'A';
            const profileImageHtml = user.profile_image 
                ? `<img src="../${user.profile_image}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">`
                : `<div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #0066cc, #0052a3); display: inline-flex; align-items: center; justify-content: center; font-size: 32px; color: white; font-weight: bold;">${initial}</div>`;
            
            const { value: formValues } = await Swal.fire({
                title: 'My Profile',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div id="profileImagePreview">${profileImageHtml}</div>
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="previewProfileImage(this)">
                            <button onclick="document.getElementById('profileImageInput').click()" style="margin-top: 10px; padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-camera"></i> Change Photo
                            </button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Full Name</label>
                            <input type="text" id="profileName" value="${user.full_name || ''}" class="swal2-input" style="width: 100%; margin: 0;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Email</label>
                            <input type="email" id="profileEmail" value="${user.email || ''}" class="swal2-input" style="width: 100%; margin: 0;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Phone</label>
                            <input type="tel" id="profilePhone" value="${user.phone || ''}" class="swal2-input" style="width: 100%; margin: 0;">
                        </div>
                        
                        <div style="border-top: 2px solid #e9ecef; margin: 25px 0; padding-top: 20px;">
                            <h4 style="color: #0066cc; margin-bottom: 15px;"><i class="fas fa-key"></i> Change Password (Optional)</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Current Password</label>
                                <input type="password" id="currentPasswordProfile" class="swal2-input" style="width: 100%; margin: 0;" placeholder="Leave blank to keep current password">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">New Password</label>
                                <input type="password" id="newPasswordProfile" class="swal2-input" style="width: 100%; margin: 0;" placeholder="Leave blank to keep current password">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Confirm New Password</label>
                                <input type="password" id="confirmPasswordProfile" class="swal2-input" style="width: 100%; margin: 0;" placeholder="Leave blank to keep current password">
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#0066cc',
                width: '550px',
                preConfirm: () => {
                    const currentPassword = document.getElementById('currentPasswordProfile').value;
                    const newPassword = document.getElementById('newPasswordProfile').value;
                    const confirmPassword = document.getElementById('confirmPasswordProfile').value;
                    
                    // Validate password change if any password field is filled
                    if (currentPassword || newPassword || confirmPassword) {
                        if (!currentPassword) {
                            Swal.showValidationMessage('Please enter your current password to change it');
                            return false;
                        }
                        if (!newPassword) {
                            Swal.showValidationMessage('Please enter a new password');
                            return false;
                        }
                        if (newPassword !== confirmPassword) {
                            Swal.showValidationMessage('New passwords do not match');
                            return false;
                        }
                    }
                    
                    return {
                        full_name: document.getElementById('profileName').value,
                        email: document.getElementById('profileEmail').value,
                        phone: document.getElementById('profilePhone').value,
                        profile_image: document.getElementById('profileImageInput').files[0],
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    };
                }
            });
            
            if (formValues) {
                await saveProfileAndPassword(formValues);
            }
        }
        
        function previewProfileImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImagePreview').innerHTML = 
                        `<img src="${e.target.result}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function saveProfileAndPassword(data) {
            try {
                // First, save profile data
                const formData = new FormData();
                formData.append('full_name', data.full_name);
                formData.append('email', data.email);
                formData.append('phone', data.phone);
                
                if (data.profile_image) {
                    formData.append('profile_image', data.profile_image);
                }
                
                const profileResponse = await fetch('../api/profile/update.php', {
                    method: 'POST',
                    body: formData
                });
                
                const profileResult = await profileResponse.json();
                
                if (!profileResult.success) {
                    throw new Error(profileResult.message);
                }
                
                // If password fields are filled, change password
                if (data.current_password && data.new_password) {
                    const passwordResponse = await fetch('../api/profile/change-password.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            current_password: data.current_password,
                            new_password: data.new_password,
                            confirm_password: data.confirm_password
                        })
                    });
                    
                    const passwordResult = await passwordResponse.json();
                    
                    if (!passwordResult.success) {
                        throw new Error(passwordResult.message);
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Profile and password updated successfully!',
                        confirmButtonColor: '#0066cc'
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: profileResult.message,
                        confirmButtonColor: '#0066cc'
                    });
                }
                
                loadUserProfile(); // Reload profile
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }
        
        // Account Settings
        function openAccountSettings() {
            Swal.fire({
                title: 'Account Settings',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #0066cc; margin-bottom: 10px;"><i class="fas fa-bell"></i> Notifications</h4>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" checked> Email notifications for new admissions
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox" checked> Email notifications for new messages
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox"> SMS notifications
                            </label>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #0066cc; margin-bottom: 10px;"><i class="fas fa-shield-alt"></i> Security</h4>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="checkbox"> Enable two-factor authentication
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" checked> Require password change every 90 days
                            </label>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Settings',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#0066cc',
                width: '500px'
            });
        }
        
        // Change Password
        async function openChangePassword() {
            const { value: formValues } = await Swal.fire({
                title: 'Change Password',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Current Password</label>
                            <input type="password" id="currentPassword" class="swal2-input" style="width: 100%; margin: 0;" placeholder="Enter current password">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">New Password</label>
                            <input type="password" id="newPassword" class="swal2-input" style="width: 100%; margin: 0;" placeholder="Enter new password">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="swal2-input" style="width: 100%; margin: 0;" placeholder="Confirm new password">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Change Password',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#0066cc',
                width: '500px',
                preConfirm: () => {
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        Swal.showValidationMessage('All fields are required');
                        return false;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        Swal.showValidationMessage('New passwords do not match');
                        return false;
                    }
                    
                    return {
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    };
                }
            });
            
            if (formValues) {
                await changePassword(formValues);
            }
        }
        
        async function changePassword(data) {
            try {
                const response = await fetch('../api/profile/change-password.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: result.message,
                        confirmButtonColor: '#0066cc'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }
        
        // System Settings - UI Customization
        function openSystemSettings() {
            // Get current CSS variables
            const root = document.documentElement;
            const currentPrimaryColor = getComputedStyle(root).getPropertyValue('--primary-blue').trim() || '#0066cc';
            const currentAccentColor = getComputedStyle(root).getPropertyValue('--accent-red').trim() || '#dc3545';
            
            Swal.fire({
                title: 'Dashboard Settings',
                html: `
                    <div style="text-align: left; padding: 20px; max-height: 500px; overflow-y: auto;">
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #0066cc; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-palette"></i> Color Theme
                            </h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Primary Color (Blue)</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" id="primaryColor" value="${currentPrimaryColor}" style="width: 60px; height: 40px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer;">
                                    <input type="text" id="primaryColorText" value="${currentPrimaryColor}" class="swal2-input" style="flex: 1; margin: 0;" readonly>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Accent Color (Red)</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" id="accentColor" value="${currentAccentColor}" style="width: 60px; height: 40px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer;">
                                    <input type="text" id="accentColorText" value="${currentAccentColor}" class="swal2-input" style="flex: 1; margin: 0;" readonly>
                                </div>
                            </div>
                            <div style="background: #e8f4f8; padding: 12px; border-radius: 8px; font-size: 13px; color: #0066cc;">
                                <i class="fas fa-info-circle"></i> Changes will be applied immediately
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #0066cc; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-text-height"></i> Text Size
                            </h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Base Font Size</label>
                                <select id="fontSize" class="swal2-input" style="width: 100%; margin: 0;">
                                    <option value="12px">Small (12px)</option>
                                    <option value="14px" selected>Medium (14px)</option>
                                    <option value="16px">Large (16px)</option>
                                    <option value="18px">Extra Large (18px)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #0066cc; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-moon"></i> Theme Mode
                            </h4>
                            <div style="display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #ddd; border-radius: 8px; flex: 1;">
                                    <input type="radio" name="themeMode" value="dark" checked>
                                    <span>Dark Mode</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #ddd; border-radius: 8px; flex: 1;">
                                    <input type="radio" name="themeMode" value="light">
                                    <span>Light Mode</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #0066cc; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-sliders-h"></i> Quick Presets
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <button onclick="applyPreset('default')" style="padding: 12px; background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Default Blue
                                </button>
                                <button onclick="applyPreset('green')" style="padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Green Theme
                                </button>
                                <button onclick="applyPreset('purple')" style="padding: 12px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Purple Theme
                                </button>
                                <button onclick="applyPreset('orange')" style="padding: 12px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Orange Theme
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Settings',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#0066cc',
                width: '650px',
                didOpen: () => {
                    // Update color text when color picker changes
                    document.getElementById('primaryColor').addEventListener('input', (e) => {
                        document.getElementById('primaryColorText').value = e.target.value;
                        document.documentElement.style.setProperty('--primary-blue', e.target.value);
                    });
                    document.getElementById('accentColor').addEventListener('input', (e) => {
                        document.getElementById('accentColorText').value = e.target.value;
                        document.documentElement.style.setProperty('--accent-red', e.target.value);
                    });
                    
                    // Apply font size changes
                    document.getElementById('fontSize').addEventListener('change', (e) => {
                        document.body.style.fontSize = e.target.value;
                    });
                },
                preConfirm: () => {
                    return {
                        primaryColor: document.getElementById('primaryColor').value,
                        accentColor: document.getElementById('accentColor').value,
                        fontSize: document.getElementById('fontSize').value,
                        themeMode: document.querySelector('input[name="themeMode"]:checked').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Save settings to localStorage
                    localStorage.setItem('dashboardSettings', JSON.stringify(result.value));
                    Swal.fire({
                        icon: 'success',
                        title: 'Settings Saved!',
                        text: 'Your dashboard customization has been saved.',
                        confirmButtonColor: '#0066cc',
                        timer: 2000
                    });
                }
            });
        }
        
        // Apply color presets
        function applyPreset(preset) {
            const presets = {
                default: { primary: '#0066cc', accent: '#dc3545' },
                green: { primary: '#10b981', accent: '#059669' },
                purple: { primary: '#8b5cf6', accent: '#7c3aed' },
                orange: { primary: '#f59e0b', accent: '#d97706' }
            };
            
            const colors = presets[preset];
            document.getElementById('primaryColor').value = colors.primary;
            document.getElementById('primaryColorText').value = colors.primary;
            document.getElementById('accentColor').value = colors.accent;
            document.getElementById('accentColorText').value = colors.accent;
            
            document.documentElement.style.setProperty('--primary-blue', colors.primary);
            document.documentElement.style.setProperty('--accent-red', colors.accent);
        }
        
        // Load saved settings on page load
        function loadDashboardSettings() {
            const saved = localStorage.getItem('dashboardSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.documentElement.style.setProperty('--primary-blue', settings.primaryColor);
                document.documentElement.style.setProperty('--accent-red', settings.accentColor);
                document.body.style.fontSize = settings.fontSize;
            }
        }
        
        // Activity Log
        function viewActivityLog() {
            Swal.fire({
                title: 'Activity Log',
                html: `
                    <div style="text-align: left; padding: 20px; max-height: 400px; overflow-y: auto;">
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #0066cc; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Login</div>
                            <div style="font-size: 13px; color: #666;">Logged in from 192.168.1.1</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Today at 9:30 AM</div>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #10b981; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Admission Approved</div>
                            <div style="font-size: 13px; color: #666;">Approved application APP-2026-1234</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Today at 8:45 AM</div>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #f59e0b; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Gallery Updated</div>
                            <div style="font-size: 13px; color: #666;">Added 5 new images to gallery</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Yesterday at 4:20 PM</div>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #8b5cf6; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Settings Changed</div>
                            <div style="font-size: 13px; color: #666;">Updated email configuration</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Yesterday at 2:15 PM</div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Close',
                confirmButtonColor: '#0066cc',
                width: '600px'
            });
        }
        
        // Load notification counts
        function loadNotifications() {
            fetch('../api/dashboard/get_notifications.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationBadge('admissionsBadge', data.data.admissions);
                        updateNotificationBadge('messagesBadge', data.data.messages);
                    }
                })
                .catch(error => console.error('Error loading notifications:', error));
        }
        
        function updateNotificationBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            // Also update Quick Action badges
            if (badgeId === 'admissionsBadge') {
                updateNotificationBadge('admissionsBadgeQuick', count);
                updateNotificationBadge('railAdmissionsBadge', count);
            } else if (badgeId === 'messagesBadge') {
                updateNotificationBadge('messagesBadgeQuick', count);
                updateNotificationBadge('railMessagesBadge', count);
                updateNotificationBadge('railNotificationsBadge', count); // Use same count for notifications
            }
        }
        
        // Show Notifications Panel
        function showNotificationsPanel() {
            Swal.fire({
                title: 'Notifications',
                html: `
                    <div style="text-align: left; padding: 20px; max-height: 400px; overflow-y: auto;">
                        <div style="margin-bottom: 15px; padding: 15px; background: #e8f4f8; border-left: 4px solid #0066cc; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">New Admission Application</div>
                            <div style="font-size: 13px; color: #666;">A new student has applied for admission</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">2 hours ago</div>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #10b981; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">New Message Received</div>
                            <div style="font-size: 13px; color: #666;">You have a new contact form submission</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">5 hours ago</div>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid #f59e0b; border-radius: 8px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Gallery Updated</div>
                            <div style="font-size: 13px; color: #666;">New images added to gallery</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">1 day ago</div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Close',
                confirmButtonColor: '#0066cc',
                width: '600px'
            });
        }
        
        // Show Help Panel
        function showHelpPanel() {
            Swal.fire({
                title: 'Help & Support',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #0066cc; margin-bottom: 10px;"><i class="fas fa-book"></i> Quick Guide</h4>
                            <ul style="line-height: 2; color: #666;">
                                <li>Use the sidebar to navigate between sections</li>
                                <li>Click Quick Actions for common tasks</li>
                                <li>View Recent Activity for latest updates</li>
                                <li>Check Upcoming Events for scheduled activities</li>
                            </ul>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #0066cc; margin-bottom: 10px;"><i class="fas fa-phone"></i> Contact Support</h4>
                            <p style="color: #666; line-height: 1.8;">
                                <strong>Phone:</strong> +256 772 420 506<br>
                                <strong>Email:</strong> stlawrencejuniorschoolkabowa@gmail.com<br>
                                <strong>Hours:</strong> Monday - Friday, 8:00 AM - 5:00 PM
                            </p>
                        </div>
                        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px;">
                            <strong style="color: #0066cc;">Need more help?</strong><br>
                            <span style="color: #666; font-size: 14px;">Contact your system administrator for assistance</span>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Close',
                confirmButtonColor: '#0066cc',
                width: '600px'
            });
        }

        // ==================== USER MANAGEMENT FUNCTIONS ====================
        
        let allUsers = [];
        let allRoles = [];
        
        // Load roles from database
        async function loadRoles() {
            try {
                const response = await fetch('../api/users/get_roles.php');
                const result = await response.json();
                
                if (result.success) {
                    allRoles = result.data;
                    populateRoleSelects();
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }
        
        // Populate role select dropdowns
        function populateRoleSelects() {
            const addRoleSelect = document.querySelector('#addUserForm select[name="role_id"]');
            const editRoleSelect = document.getElementById('editRoleId');
            const filterRoleSelect = document.getElementById('roleFilterSelect');
            
            // Clear existing options (except first one)
            if (addRoleSelect) {
                addRoleSelect.innerHTML = '<option value="">Select Role</option>';
                allRoles.forEach(role => {
                    addRoleSelect.innerHTML += `<option value="${role.id}">${role.role_name}</option>`;
                });
            }
            
            if (editRoleSelect) {
                editRoleSelect.innerHTML = '';
                allRoles.forEach(role => {
                    editRoleSelect.innerHTML += `<option value="${role.id}">${role.role_name}</option>`;
                });
            }
            
            if (filterRoleSelect) {
                filterRoleSelect.innerHTML = '<option value="">All Roles</option>';
                allRoles.forEach(role => {
                    filterRoleSelect.innerHTML += `<option value="${role.id}">${role.role_name}</option>`;
                });
            }
        }
        
        // Load users when modal opens
        async function loadUsers() {
            try {
                const response = await fetch('../api/users/list.php');
                const result = await response.json();
                
                if (result.success) {
                    allUsers = result.data;
                    displayUsers(allUsers);
                } else {
                    document.getElementById('usersTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" style="padding:40px;text-align:center;color:#dc3545;">
                                <i class="fas fa-exclamation-circle" style="font-size:24px;margin-bottom:10px;"></i>
                                <p style="margin:0;">${result.message}</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="padding:40px;text-align:center;color:#dc3545;">
                            <i class="fas fa-exclamation-circle" style="font-size:24px;margin-bottom:10px;"></i>
                            <p style="margin:0;">Error loading users: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding:40px;text-align:center;color:#94a3b8;">
                            <i class="fas fa-users" style="font-size:24px;margin-bottom:10px;"></i>
                            <p style="margin:0;">No users found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const roleColors = {
                    'Super Administrator': '#dc3545',
                    'Administrator': '#0066cc',
                    'Teacher': '#28a745',
                    'Accountant': '#f59e0b',
                    'Librarian': '#8b5cf6',
                    'Receptionist': '#6c757d',
                    'Parent': '#06b6d4',
                    'Student': '#ec4899'
                };
                const roleColor = roleColors[user.role_name] || '#6c757d';
                
                // Convert status to is_active format
                const isActive = user.status === 'active' ? 1 : 0;
                const statusColor = isActive == 1 ? '#10b981' : '#dc3545';
                const statusText = isActive == 1 ? 'Active' : 'Inactive';
                
                return `
                    <tr style="border-bottom:1px solid #e2e8f0;transition:background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                        <td style="padding:15px;font-size:14px;font-weight:600;color:#1e293b;">${user.username}</td>
                        <td style="padding:15px;font-size:14px;color:#475569;">${user.full_name || '-'}</td>
                        <td style="padding:15px;font-size:14px;color:#475569;">${user.email || '-'}</td>
                        <td style="padding:15px;">
                            <span style="display:inline-block;padding:6px 12px;background:${roleColor}15;color:${roleColor};border-radius:6px;font-size:12px;font-weight:600;">
                                ${user.role_name || 'No Role'}
                            </span>
                        </td>
                        <td style="padding:15px;">
                            <span style="display:inline-block;padding:6px 12px;background:${statusColor}15;color:${statusColor};border-radius:6px;font-size:12px;font-weight:600;">
                                ${statusText}
                            </span>
                        </td>
                        <td style="padding:15px;text-align:center;">
                            <button onclick="editUser(${user.id})" style="padding:8px 12px;background:#0066cc;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="toggleUserStatus(${user.id}, ${isActive})" style="padding:8px 12px;background:${isActive == 1 ? '#dc3545' : '#28a745'};color:white;border:none;border-radius:6px;cursor:pointer;margin-right:8px;font-size:13px;transition:all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                <i class="fas fa-${isActive == 1 ? 'ban' : 'check'}"></i> ${isActive == 1 ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="deleteUser(${user.id}, '${user.username}')" style="padding:8px 12px;background:#dc3545;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Filter users
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilterSelect').value;
            
            let filtered = allUsers;
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(user => 
                    user.username.toLowerCase().includes(searchTerm) ||
                    (user.full_name && user.full_name.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filter by role
            if (roleFilter) {
                filtered = filtered.filter(user => user.role_id == roleFilter);
            }
            
            displayUsers(filtered);
        }
        
        // Add new user
        async function submitAddUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Validate passwords match
            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');
            
            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Mismatch',
                    text: 'Passwords do not match!',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            try {
                const response = await fetch('../api/users/create.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'User Created!',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    e.target.reset();
                    loadUsers();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }
        
        // Edit user
        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Populate form
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editFullName').value = user.full_name || '';
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editRoleId').value = user.role_id;
            document.getElementById('editPassword').value = '';
            document.getElementById('editConfirmPassword').value = '';
            
            // Open modal
            openModal('editUserModal');
        }
        
        // Submit edit user
        async function submitEditUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Validate passwords match if provided
            const password = formData.get('password');
            const confirmPassword = formData.get('confirm_password');
            
            if (password && password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Mismatch',
                    text: 'Passwords do not match!',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            try {
                const response = await fetch('../api/users/update.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'User Updated!',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    closeModal('editUserModal');
                    loadUsers();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        }
        
        // Toggle user status
        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus == 1 ? 0 : 1;
            const action = newStatus == 1 ? 'activate' : 'deactivate';
            
            const result = await Swal.fire({
                title: `${action.charAt(0).toUpperCase() + action.slice(1)} User?`,
                text: `Are you sure you want to ${action} this user?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#0066cc',
                cancelButtonColor: '#6c757d',
                confirmButtonText: `Yes, ${action}!`,
                cancelButtonText: 'Cancel'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('../api/users/toggle-status.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: userId, is_active: newStatus})
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Status Updated!',
                            text: result.message,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadUsers();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            }
        }
        
        // Delete user
        async function deleteUser(userId, username) {
            const result = await Swal.fire({
                title: 'Delete User?',
                html: `Are you sure you want to delete user <strong>${username}</strong>?<br><br><span style="color:#dc3545;">This action cannot be undone!</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('../api/users/delete.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: userId})
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: result.message,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadUsers();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            }
        }
        
        // Override openModal to load users when User Management modal opens
        const originalOpenModal = openModal;
        openModal = function(modalId) {
            originalOpenModal(modalId);
            if (modalId === 'userManagementModal') {
                loadRoles();
                loadUsers();
            }
        };
        
        // Load roles on page load
        loadRoles();
    </script>
</body>
</html>
